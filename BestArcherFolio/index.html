<html lang="es">
<head>
<meta charset="utf-8">
<title>BestArcher_ | Portfolio</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="color-scheme" content="dark">
<meta name="theme-color" content="#060607">
<link rel="icon" href="assets/profile.jpg">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet"
  href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css"
  crossorigin="anonymous" referrerpolicy="no-referrer" />
<style>
:root{
  --bg:#0A0A0B;--text:#F2F2F6;--muted:#A6A6BF;
  --card:rgba(255,255,255,.055);--border:rgba(255,255,255,.14);
  --grad:linear-gradient(180deg,rgba(255,255,255,.18),rgba(255,255,255,.06));
  --hover:linear-gradient(180deg,rgba(255,255,255,.3),rgba(255,255,255,.12));
  --radius:26px;--focus:rgba(255,255,255,.45);
  font-family:'Poppins',system-ui,sans-serif;
}
*{box-sizing:border-box;margin:0;padding:0}
body{background:var(--bg);color:var(--text);-webkit-font-smoothing:antialiased;overflow-x:hidden}
a{text-decoration:none;color:inherit}
img{display:block;max-width:100%}
ul,li{list-style:none;margin:0;padding:0}
:focus-visible{outline:2px solid var(--focus);outline-offset:3px;border-radius:8px}
::-webkit-scrollbar{width:10px;height:10px}::-webkit-scrollbar-thumb{background:#252629;border-radius:20px}

/* BACKGROUNDS */
.bg{position:fixed;inset:0;z-index:-3;background:#060607}
#bgParticles{position:absolute;inset:0;display:none}
#bgAurora{position:absolute;inset:0;display:none;pointer-events:none}
.aur{position:absolute;width:70vmax;height:70vmax;filter:blur(70px);opacity:.34;transform:translate(-50%,-50%);
background:
 radial-gradient(circle at 30% 30%,#34363a,transparent 60%),
 radial-gradient(circle at 65% 72%,#3d3f43,transparent 60%),
 radial-gradient(circle at 50% 10%,#4a4c50,transparent 55%);
mix-blend-mode:screen;animation:aur 24s ease-in-out infinite}
@keyframes aur{0%,100%{transform:translate(-50%,-50%) scale(1)}50%{transform:translate(-48%,-52%) scale(1.03)}}
#a1{top:20%;left:20%}#a2{top:70%;left:80%;animation-delay:5s}#a3{top:52%;left:52%;animation-delay:10s}

#bgCar{position:absolute;inset:0;display:none;overflow:hidden;background:#040506}
#bgCar.no-img .car-img{display:none}
#bgCar .car-img{position:absolute;inset:0;background:url("assets/backgrounds/car.jpg") center/cover no-repeat;opacity:.44;filter:contrast(1.07) brightness(.87)}
#bgCar .wash{position:absolute;inset:0;
 background:
   radial-gradient(circle at 70% 55%,rgba(255,0,0,.28),transparent 60%),
   radial-gradient(circle at 35% 40%,rgba(0,160,110,.25),transparent 65%),
   linear-gradient(#050607,#0a0d11);mix-blend-mode:screen}
#bgCar .vignette{position:absolute;inset:0;background:radial-gradient(circle at 50% 55%,rgba(0,0,0,0) 0%,rgba(0,0,0,.42) 55%,#000 100%)}
.smoke{position:absolute;width:160%;height:160%;top:50%;left:50%;transform:translate(-50%,-50%);
background:
 radial-gradient(circle at 30% 40%,rgba(255,255,255,.07),transparent 60%),
 radial-gradient(circle at 70% 60%,rgba(255,255,255,.06),transparent 65%);
filter:blur(80px);mix-blend-mode:screen;animation:smk 60s linear infinite;opacity:.5}
.smoke.s2{animation-direction:reverse;animation-duration:70s;opacity:.36}
.smoke.s3{animation-duration:82s;opacity:.41}
@keyframes smk{
  0%{transform:translate(-50%,-50%) rotate(0deg) scale(1)}
  50%{transform:translate(-50%,-52%) rotate(180deg) scale(1.05)}
  100%{transform:translate(-50%,-50%) rotate(360deg) scale(1)}
}

.bg-image{position:absolute;inset:0;background-size:cover;background-position:center;background-repeat:no-repeat;display:none;opacity:.33;filter:grayscale(.15) contrast(1.05)}

/* ENTRY */
.entry{position:fixed;inset:0;z-index:50;display:flex;align-items:center;justify-content:center;
background:radial-gradient(circle at 50% 45%,rgba(255,255,255,.085),rgba(0,0,0,.88));backdrop-filter:blur(18px);cursor:pointer}
.entry-box{position:relative;padding:60px 78px;border:1px solid rgba(255,255,255,.16);border-radius:48px;background:rgba(255,255,255,.07);text-align:center}
.entry-title{margin:0 0 16px;font-size:clamp(2.6rem,4.2vw,3.9rem);font-weight:700;letter-spacing:.9px}
.entry-sub{margin:0;font-size:.82rem;letter-spacing:4px;color:#d5d5dc}
.entry-ring{position:absolute;inset:-2px;border-radius:inherit;background:
conic-gradient(from 0deg,rgba(255,255,255,.22),transparent 40%,transparent 60%,rgba(255,255,255,.22));
animation:spin 3s linear infinite;mix-blend-mode:overlay;opacity:.7}
.fade-out{animation:fout .55s ease forwards}@keyframes fout{to{opacity:0;visibility:hidden}}
body.modal-open{overflow:hidden}

/* TOPBAR */
.topbar{position:sticky;top:0;z-index:40;display:flex;justify-content:space-between;align-items:center;
padding:10px 22px;background:rgba(15,16,20,.55);backdrop-filter:blur(18px) saturate(170%);border-bottom:1px solid rgba(255,255,255,.1)}
.brand{display:flex;align-items:center;gap:12px;font-weight:700;font-size:1.07rem}
.ig-verified{--s:24px;width:var(--s);height:var(--s);border-radius:50%;background:radial-gradient(circle at 30% 30%,#fff,#d8d8d8 70%);box-shadow:0 0 0 2px rgba(255,255,255,.22),0 0 7px rgba(255,255,255,.25);position:relative}
.ig-verified:after{content:"";position:absolute;inset:0;background:linear-gradient(150deg,#fff,#d7d7d7);mask:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='white' viewBox='0 0 24 24'%3E%3Cpath d='M9.55 16.05a1 1 0 0 1-.7-.29l-3.31-3.31a1 1 0 0 1 1.41-1.41l2.6 2.6 6.5-6.5a1 1 0 0 1 1.41 1.41l-7.2 7.2a1 1 0 0 1-.71.3z'/%3E%3C/svg%3E") center/60% 60% no-repeat}

/* PAGE */
.page{display:flex;flex-direction:column;gap:30px;align-items:center;padding:26px 18px 80px}
.card{width:100%;max-width:1180px;background:var(--card);border:1px solid var(--border);border-radius:var(--radius);
backdrop-filter:blur(20px) saturate(165%);padding:34px 36px;position:relative;overflow:hidden}
.card:after{content:"";position:absolute;inset:-1px;padding:1px;border-radius:inherit;background:
linear-gradient(140deg,rgba(255,255,255,.12),transparent);
-webkit-mask:linear-gradient(#000 0 0) content-box,linear-gradient(#000 0 0);-webkit-mask-composite:xor;mask-composite:exclude;pointer-events:none}

/* HERO */
.hero{display:grid;grid-template-columns:230px 1fr;gap:42px}
@media (max-width:880px){.hero{grid-template-columns:1fr}}
.avatar-wrap{position:relative;width:190px}
.avatar{width:190px;height:190px;border-radius:50%;border:5px solid rgba(255,255,255,.55);object-fit:cover;
box-shadow:0 0 0 7px rgba(255,255,255,.09),0 20px 50px -12px rgba(0,0,0,.75)}
.name{margin:0 0 16px;font-size:clamp(2.35rem,2.6vw + 1rem,3.15rem);font-weight:700;display:flex;align-items:center;gap:10px;letter-spacing:.65px;flex-wrap:wrap}
.status-dot-inline{width:12px;height:12px;border-radius:50%;background:#2fd06d;border:2px solid #0c0f12;box-shadow:0 0 4px #2fd06d,0 0 10px #2fd06d;display:inline-block}
.bio{margin:8px 0 34px;color:var(--muted);line-height:1.55;max-width:74ch;letter-spacing:.25px}

/* SOCIAL */
.social-hub{display:flex;flex-direction:column;gap:26px}
.social-icons{display:flex;gap:12px;flex-wrap:wrap;background:rgba(255,255,255,.07);padding:16px 18px;border:1px solid rgba(255,255,255,.13);border-radius:24px}
.icon-btn{width:46px;height:46px;display:grid;place-items:center;border-radius:16px;background:var(--grad);border:1px solid rgba(255,255,255,.18);color:#fff;cursor:pointer;transition:transform .26s,background .26s}
.icon-btn:hover{transform:translateY(-5px);background:var(--hover)}
.icon-btn:active{transform:translateY(-2px)}
.social-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(168px,1fr));gap:18px;font-size:0}
.s-card{font-size:initial;position:relative;padding:16px 16px 14px;border:1px solid rgba(255,255,255,.15);border-radius:22px;
background:linear-gradient(175deg,rgba(255,255,255,.08),rgba(255,255,255,.03));display:flex;flex-direction:column;gap:8px;
font-size:.85rem;font-weight:600;cursor:pointer;transition:transform .26s,border-color .28s,background .35s}
.s-card small{font-size:.58rem;color:#d6d6dc;letter-spacing:.55px;text-transform:uppercase}
.s-card:hover{transform:translateY(-6px);border-color:rgba(255,255,255,.3);background:linear-gradient(175deg,rgba(255,255,255,.15),rgba(255,255,255,.05))}
.s-thumb{width:48px;height:48px;border-radius:15px;overflow:hidden;background:rgba(255,255,255,.1);display:flex;align-items:center;justify-content:center}
.s-thumb img{width:100%;height:100%;object-fit:cover}
.s-card[data-copy]:after{content:"Copiar";position:absolute;top:8px;right:12px;font-size:.53rem;color:#a8a8b2;letter-spacing:.6px}

/* STATS */
.stats{display:flex;flex-wrap:wrap;gap:22px;padding:4px 2px 2px;justify-content:center}
.stat-chip{background:rgba(255,255,255,.075);border:1px solid rgba(255,255,255,.17);padding:14px 18px;border-radius:16px;font-size:.82rem;font-weight:600;letter-spacing:.4px;min-width:160px;text-align:center;display:flex;flex-direction:column;align-items:center;justify-content:center}
.stat-chip strong{color:#fff}
@media (max-width:600px){.stat-chip{flex:1 1 calc(50% - 22px)}}

/* SECTION TITLE */
.section-title{margin:0 0 24px;font-size:1.26rem;letter-spacing:.55px;font-weight:600;display:flex;align-items:center;gap:10px}

/* SERVERS */
.servers .grid{display:grid;gap:22px;grid-template-columns:repeat(auto-fill,minmax(232px,1fr))}
.srv-card{position:relative;border-radius:24px;background:rgba(255,255,255,.075);border:1px solid rgba(255,255,255,.16);min-height:205px;display:flex;flex-direction:column;cursor:pointer;overflow:hidden;transition:transform .28s,border-color .28s,box-shadow .4s}
.srv-card:hover{transform:translateY(-6px);border-color:rgba(255,255,255,.3);box-shadow:0 14px 40px -12px rgba(0,0,0,.75)}
.srv-card.now-focus{box-shadow:0 0 0 2px rgba(120,200,255,.65),0 0 22px -4px rgba(120,200,255,.85)}
.sheen{position:absolute;inset:0;background:linear-gradient(125deg,transparent 35%,rgba(255,255,255,.15) 52%,transparent 70%);opacity:0;transition:opacity .45s;pointer-events:none}
.srv-card:hover .sheen{opacity:1}
.srv-inner{display:flex;flex-direction:column;padding:16px 18px 14px;flex:1}
.srv-top{display:flex;align-items:center;gap:14px}
.srv-logo{width:72px;height:72px;border-radius:20px;background:#101114;display:flex;align-items:center;justify-content:center;overflow:hidden;border:1px solid rgba(255,255,255,.18);position:relative}
.srv-logo img{width:100%;height:100%;object-fit:cover;display:block;transition:transform .4s}
.srv-card:hover .srv-logo img{transform:scale(1.07)}
.srv-logo.logo-fallback{background:#16181d;font-weight:700;font-size:1.1rem;letter-spacing:.5px;color:#fff}
.srv-meta h3{margin:0;font-size:.95rem;font-weight:700;letter-spacing:.3px}
.srv-year{color:var(--muted);font-size:.63rem;letter-spacing:.5px}
.srv-roles{margin:10px 0 0;color:#dadade;font-size:.68rem;line-height:1.45;letter-spacing:.32px;flex:1}
.srv-btn{margin-top:12px;border:1px solid rgba(255,255,255,.25);background:var(--grad);color:#fff;height:42px;border-radius:14px;cursor:pointer;font-size:.68rem;font-weight:600;letter-spacing:.5px;transition:transform .26s,background .26s}
.srv-btn:hover{transform:translateY(-4px);background:var(--hover)}
.srv-btn:active{transform:translateY(-1px)}

/* ACHIEVEMENTS */
.achievements{display:flex;flex-direction:column;gap:26px}
.ach-lists{display:grid;gap:30px;grid-template-columns:repeat(auto-fit,minmax(350px,1fr))}
.ach-box{background:rgba(255,255,255,.07);border:1px solid rgba(255,255,255,.16);padding:20px 22px 22px;border-radius:22px;display:flex;flex-direction:column;gap:14px}
.ach-box h3{margin:0;font-size:.9rem;letter-spacing:.58px;text-transform:uppercase;color:#e5e5ea}
.ach-box ul{display:grid;gap:10px}
.ach-box li{font-size:.68rem;display:flex;align-items:flex-start;gap:8px;line-height:1.48;letter-spacing:.42px;color:#f0f0f4}
.ach-box li i{width:18px;text-align:center;opacity:.85;font-size:.8rem;margin-top:1px}

/* MUSIC */
.music.card{padding:28px 32px 34px}
.music-simple{display:flex;flex-direction:column;gap:16px}
.music-controls-basic{display:flex;gap:12px;flex-wrap:wrap}
.music-controls-basic .btn{flex:1;min-width:90px}
#musicState{font-size:.65rem;color:#d0d0d6;letter-spacing:.5px;font-weight:600}
.volume-wrap{display:flex;align-items:center;gap:12px}
.volume-wrap input[type=range]{flex:1;-webkit-appearance:none;appearance:none;height:6px;background:rgba(255,255,255,.23);border-radius:999px;outline:none}
.volume-wrap input[type=range]::-webkit-slider-thumb{-webkit-appearance:none;width:16px;height:16px;border-radius:50%;background:#fff;box-shadow:0 0 0 2px rgba(0,0,0,.55),0 0 10px rgba(255,255,255,.4);cursor:pointer}
.volume-wrap input[type=range]::-moz-range-thumb{width:16px;height:16px;border-radius:50%;background:#fff;border:0;box-shadow:0 0 0 2px rgba(0,0,0,.55),0 0 10px rgba(255,255,255,.4);cursor:pointer}

/* PANELS */
.panel-grid{display:flex;flex-direction:column;gap:30px}
.panels-horizontal{display:flex;flex-wrap:wrap;gap:20px}
.panels-horizontal .mini-panel{flex:1 1 clamp(240px,24%,300px);min-width:240px}
.mini-panel.card{padding:24px 26px 26px}
.panel-head{display:flex;justify-content:space-between;align-items:center;margin-bottom:14px}
.panel-head h3{margin:0;font-size:.78rem;letter-spacing:.6px;text-transform:uppercase;color:#e3e3ea}
.inline-edit{cursor:default;position:relative;padding:8px 12px;border:1px solid rgba(255,255,255,.18);border-radius:14px;background:rgba(255,255,255,.09);font-size:.72rem;min-height:54px;line-height:1.45;white-space:pre-wrap}
.inline-edit[contenteditable="true"]{cursor:text;outline:2px solid rgba(255,255,255,.55)}
.objectives-list{display:grid;gap:9px;font-size:.68rem}
.objectives-list li{display:flex;align-items:center;gap:10px;padding:8px 12px;border:1px solid rgba(255,255,255,.18);background:rgba(255,255,255,.085);border-radius:14px;cursor:pointer;transition:background .3s,border-color .3s}
.objectives-list li.done{opacity:.55;text-decoration:line-through}
.objectives-list li button{margin-left:auto}
.add-row{display:flex;gap:10px;margin-top:12px}
.add-row input{flex:1;padding:10px 12px;border-radius:12px;border:1px solid rgba(255,255,255,.25);background:rgba(255,255,255,.09);color:#fff;font-size:.65rem}

.obj-progress{margin-top:14px;display:flex;align-items:center;gap:10px;font-size:.6rem;letter-spacing:.5px}
.obj-progress .bar{flex:1;height:8px;background:#1a1c20;border-radius:6px;position:relative;overflow:hidden}
.obj-progress .bar span{position:absolute;inset:0;background:linear-gradient(90deg,#3ddc97,#2ca7ff);width:0;transition:width .45s}
.obj-progress .txt{min-width:90px;text-align:right;color:#d5d8de;font-weight:600}

/* CHANGELOG */
.changelog-list{display:flex;flex-direction:column;gap:10px;max-height:230px;overflow:auto;white-space:normal;word-break:break-word;overflow-wrap:anywhere;font-size:.62rem}
.changelog-list li{padding:9px 11px;border:1px solid rgba(255,255,255,.18);background:rgba(255,255,255,.1);border-radius:12px;display:flex;flex-direction:column;gap:4px;line-height:1.45}
.changelog-list li span:first-child{display:block}
.cl-date{font-size:.54rem;opacity:.7;letter-spacing:.55px}

.placeholder-box{font-size:.65rem;opacity:.65;padding:16px 14px;border:1px dashed rgba(255,255,255,.3);border-radius:16px;text-align:center}
.last-update{font-size:.65rem;color:#d4d5da;letter-spacing:.5px;line-height:1.5;word-break:break-word}

/* ADMIN LOCK */
[data-admin]{display:none !important;}
.admin-mode [data-admin]{display:inline-flex !important;}
.admin-mode .add-row[data-admin]{display:flex !important;}

/* MODES */
.clean-mode .servers,
.clean-mode .achievements,
.clean-mode .music,
.clean-mode .stats{display:none!important}
.streaming-mode .music,
.streaming-mode #debugPanel{display:none!important}
.streaming-mode .badge-mode{display:block !important;background:#0091ff;box-shadow:0 0 0 2px rgba(0,145,255,.5),0 0 16px -2px rgba(0,145,255,.85)}

.footer{text-align:center;font-size:.64rem;color:var(--muted);letter-spacing:.55px;padding-top:10px}

/* BUTTONS */
.btn{--h:44px;height:var(--h);padding:0 18px;border-radius:16px;border:1px solid rgba(255,255,255,.22);background:var(--grad);
color:#fff;cursor:pointer;display:inline-flex;align-items:center;justify-content:center;font-weight:600;font-size:.7rem;letter-spacing:.52px;position:relative;transition:transform .25s,background .25s}
.btn:hover{transform:translateY(-4px);background:var(--hover)}
.btn:active{transform:translateY(-2px)}
.btn.small{--h:36px;padding:0 14px;font-size:.58rem;letter-spacing:.55px}
.btn.icon{width:44px;padding:0;justify-content:center}
.btn.danger{background:linear-gradient(180deg,rgba(255,60,90,.42),rgba(255,60,90,.18));border-color:rgba(255,90,120,.45)}
.btn.danger:hover{background:linear-gradient(180deg,rgba(255,60,90,.55),rgba(255,60,90,.25))}
.btn.is-active{box-shadow:0 0 0 1px rgba(255,255,255,.28),0 0 10px -2px rgba(255,255,255,.6);background:var(--hover)}

.mode-toggle-bar{display:flex;gap:10px;align-items:center}
.mode-btn{--h:38px;height:var(--h);padding:0 14px;border-radius:14px;
  border:1px solid rgba(255,255,255,.25);
  background:linear-gradient(180deg,rgba(255,255,255,.14),rgba(255,255,255,.04));
  font-size:.62rem;letter-spacing:.6px;font-weight:600;cursor:pointer;color:#fff;
  display:inline-flex;align-items:center;gap:6px;transition:background .25s,box-shadow .25s,transform .25s}
.mode-btn:hover{transform:translateY(-3px);background:linear-gradient(180deg,rgba(255,255,255,.22),rgba(255,255,255,.09))}
.mode-btn.is-active{background:linear-gradient(180deg,rgba(120,200,255,.38),rgba(120,200,255,.15));
  box-shadow:0 0 0 1px rgba(120,200,255,.7),0 0 14px -2px rgba(120,200,255,.9);border-color:rgba(120,200,255,.7)}

/* MODAL */
#serverModal{padding:0;border:0}
#serverModal[open]{display:flex;position:fixed;inset:0;margin:0;align-items:center;justify-content:center;z-index:200}
#serverModal::backdrop{background:rgba(0,0,0,.55);backdrop-filter:blur(8px)}
.modal-box{width:min(92vw,720px);max-height:88vh;overflow:auto;background:var(--card);border:1px solid var(--border);border-radius:30px;
padding:26px 28px 32px;position:relative;animation:mIn .35s ease}
@keyframes mIn{from{opacity:0;transform:translateY(30px)}to{opacity:1;transform:translateY(0)}}
.modal-close{position:absolute;top:14px;right:14px;width:46px;height:46px;border:1px solid rgba(255,255,255,.24);
background:var(--grad);border-radius:15px;color:#fff;cursor:pointer;display:grid;place-items:center}
.modal-head{display:flex;align-items:center;gap:22px;padding:10px 0 22px;border-bottom:1px solid rgba(255,255,255,.13)}
.modal-logo{width:66px;height:66px;border-radius:19px;background:linear-gradient(180deg,rgba(255,255,255,.2),rgba(255,255,255,.08));display:grid;place-items:center;font-weight:800;font-size:1rem;overflow:hidden;color:#fff}
.modal-content{padding:24px 4px 20px;display:flex;flex-direction:column;gap:16px}
.coming{margin:0;font-size:.72rem;letter-spacing:2px;font-weight:700;color:#f3f3f7}
.server-desc{font-size:.7rem;line-height:1.5;color:#d7d7dd;letter-spacing:.4px}
.server-tags{display:flex;flex-wrap:wrap;gap:8px}
.server-tag{font-size:.58rem;padding:6px 8px;border:1px solid rgba(255,255,255,.24);background:rgba(255,255,255,.13);border-radius:8px;letter-spacing:.5px;font-weight:600}
.modal-actions{display:flex;justify-content:flex-end;gap:14px;padding-top:12px}

/* SETTINGS PANEL */
#settingsPanel{
  position:fixed;top:0;right:-400px;width:380px;height:100vh;z-index:220;
  background:rgba(14,14,18,.95);backdrop-filter:blur(22px) saturate(170%);
  border-left:1px solid rgba(255,255,255,.18);
  display:flex;flex-direction:column;padding:26px 28px 36px;
  transition:right .55s cubic-bezier(.68,.05,.25,1);
}
#settingsPanel.open{right:0}
#settingsPanel h3{margin:0 0 20px;font-size:1.05rem;font-weight:600;letter-spacing:.58px}
#settingsClose{position:absolute;top:14px;right:14px;width:46px;height:46px;border:1px solid rgba(255,255,255,.24);background:var(--grad);color:#fff;border-radius:15px;cursor:pointer;display:grid;place-items:center}
.setting-block{margin-bottom:22px}
.setting-block .title{font-size:.62rem;letter-spacing:.65px;text-transform:uppercase;font-weight:600;margin:0 0 12px;color:#dedee4}
.setting-row{display:flex;flex-wrap:wrap;gap:16px;font-size:.67rem;letter-spacing:.47px}
.setting-row label{display:flex;align-items:center;gap:6px;cursor:pointer}
.setting-block input[type=url]{width:100%;padding:10px 12px;background:rgba(255,255,255,.12);border:1px solid rgba(255,255,255,.26);
  border-radius:10px;color:#fff;font-size:.64rem}
#settingsSave{margin-top:6px;width:100%}

/* TOAST */
#toast{position:fixed;left:50%;bottom:36px;transform:translate(-50%,22px);background:rgba(0,0,0,.75);
padding:14px 22px;border-radius:16px;border:1px solid rgba(255,255,255,.24);
font-size:.62rem;letter-spacing:.55px;opacity:0;pointer-events:none;z-index:400;transition:opacity .45s,transform .45s}
#toast.show{opacity:1;transform:translate(-50%,0)}

/* DEBUG */
#debugPanel{position:fixed;top:78px;right:22px;width:320px;max-height:55vh;overflow:auto;
background:rgba(0,0,0,.82);border:1px solid rgba(255,255,255,.22);border-radius:18px;padding:14px 16px;
font-size:.6rem;line-height:1.4;display:none;z-index:140;backdrop-filter:blur(12px)}
#debugPanel.show{display:block}
#debugPanel pre{margin:8px 0 0;white-space:pre-wrap;word-break:break-word;font-family:ui-monospace,monospace;font-size:.58rem}

.ripple{position:absolute;border-radius:50%;transform:translate(-50%,-50%);background:rgba(255,255,255,.35);
width:10px;height:10px;pointer-events:none;animation:ripple .6s ease-out forwards}
@keyframes ripple{from{opacity:.6}to{width:240px;height:240px;opacity:0}}

.cursor-dot,.cursor-ring{display:none}
.cursor-ring.glow{box-shadow:0 0 14px rgba(255,255,255,.5),0 0 34px rgba(255,255,255,.25)}

@media (prefers-reduced-motion:reduce){
  .smoke,.aur,.entry-ring{animation:none!important}
  .srv-card,.s-card,.btn,.icon-btn{transition:none!important}
}
</style>
</head>
<body>
<!-- BACKGROUNDS -->
<div class="bg">
  <canvas id="bgParticles"></canvas>
  <div id="bgAurora"><div class="aur" id="a1"></div><div class="aur" id="a2"></div><div class="aur" id="a3"></div></div>
  <div id="bgCar">
    <div class="wash"></div>
    <div class="smoke s1"></div><div class="smoke s2"></div><div class="smoke s3"></div>
    <div class="car-img"></div>
    <div class="vignette"></div>
  </div>
  <div id="bgImage" class="bg-image"></div>
</div>

<!-- ENTRY -->
<div id="entry" class="entry">
  <div class="entry-box">
    <h1 class="entry-title">BestArcher_</h1>
    <p class="entry-sub">CLICK ANYWHERE TO ENTER</p>
    <div class="entry-ring"></div>
  </div>
</div>

<!-- TOPBAR -->
<nav class="topbar">
  <div class="brand">
    <span>BestArcher_</span>
    <span class="ig-verified"></span>
  </div>
  <div style="display:flex;gap:10px;align-items:center">
    <button id="openSettings" class="btn small" type="button"><i class="fa-solid fa-gear"></i> Settings</button>
    <button id="toggleDebug" class="btn small" type="button" hidden><i class="fa-solid fa-bug"></i> Debug</button>
    <div class="mode-toggle-bar">
      <button id="toggleClean" class="mode-btn" type="button" title="Clean Mode"><i class="fa-solid fa-eye-slash"></i> Clean</button>
      <button id="toggleStream" class="mode-btn" type="button" title="Streaming Mode"><i class="fa-solid fa-tower-broadcast"></i> Stream</button>
      <button id="toggleLogoFit" class="mode-btn" type="button" title="Logos Cover"><i class="fa-solid fa-square"></i> Logos</button>
    </div>
  </div>
</nav>

<div class="badge-mode" id="modeBadge" style="display:none;position:fixed;top:70px;left:50%;transform:translateX(-50%);padding:6px 14px;border-radius:20px;font-size:.62rem;font-weight:600;letter-spacing:.6px;z-index:60;">STREAM MODE</div>

<main class="page" id="appRoot">

  <!-- HERO -->
  <header class="hero card">
    <div class="avatar-wrap">
      <img class="avatar" src="assets/profile.jpg" alt="Perfil" onerror="this.src='assets/profile.jpg'">
    </div>
    <div>
      <h1 class="name">BestArcher_ <span class="status-dot-inline"></span> <span class="ig-verified"></span></h1>
      <p class="bio">Learning the best SS method · SS Verify Experience · SS Manager Experience · Staff on DynamicPvP</p>

      <div class="social-hub" id="socialHub">
        <div class="social-icons">
          <a class="icon-btn" href="https://namemc.com/profile/BestArcher_" target="_blank"><i class="fa-solid fa-user"></i></a>
          <a class="icon-btn" href="https://www.instagram.com/tomas_attanzio/" target="_blank"><i class="fa-brands fa-instagram"></i></a>
          <a class="icon-btn" href="https://discord.com/users/1159617478725480580" target="_blank"><i class="fa-brands fa-discord"></i></a>
          <a class="icon-btn" href="https://github.com/BravveSS" target="_blank"><i class="fa-brands fa-github"></i></a>
          <a class="icon-btn" href="https://www.paypal.com/paypalme/my/profile" target="_blank"><i class="fa-brands fa-paypal"></i></a>
          <a class="icon-btn" href="https://www.tiktok.com/@tomasattanzio" target="_blank"><i class="fa-brands fa-tiktok"></i></a>
          <a class="icon-btn" href="https://www.youtube.com/@144_hz" target="_blank"><i class="fa-brands fa-youtube"></i></a>
          <button class="icon-btn" data-copy="tomasattanzioc@gmail.com" title="Copiar correo"><i class="fa-solid fa-envelope"></i></button>
        </div>

        <div class="social-grid" id="socialGrid">
          <div class="s-card" data-copy="BestArcher_">
            <div class="s-thumb"><img src="assets/social/discord.png" onerror="this.remove()"></div>
            <span>Discord ID</span><small>Copiar</small>
          </div>
          <a class="s-card" href="https://github.com/BravveSS" target="_blank">
            <div class="s-thumb"><img src="assets/social/github.png" onerror="this.remove()"></div>
            <span>GitHub</span><small>Perfil</small>
          </a>
          <a class="s-card" href="https://www.instagram.com/tomas_attanzio/" target="_blank">
            <div class="s-thumb"><img src="assets/social/instagram.png" onerror="this.remove()"></div>
            <span>Instagram</span><small>Ver</small>
          </a>
            <a class="s-card" href="https://www.paypal.com/paypalme/my/profile" target="_blank">
            <div class="s-thumb"><img src="assets/social/paypal.png" onerror="this.remove()"></div>
            <span>PayPal</span><small>Support</small>
          </a>
          <a class="s-card" href="https://namemc.com/profile/BestArcher_" target="_blank">
            <div class="s-thumb"><img src="assets/social/namemc.png" onerror="this.remove()"></div>
            <span>NameMC</span><small>Skin</small>
          </a>
          <a class="s-card" href="https://www.tiktok.com/@tomasattanzio" target="_blank">
            <div class="s-thumb"><img src="assets/social/tiktok.png" onerror="this.remove()"></div>
            <span>TikTok</span><small>Perfil</small>
          </a>
          <a class="s-card" href="https://www.youtube.com/@144_hz" target="_blank">
            <div class="s-thumb"><img src="assets/social/youtube.png" onerror="this.remove()"></div>
            <span>YouTube</span><small>Channel</small>
          </a>
          <div class="s-card" data-copy="tomasattanzioc@gmail.com">
            <div class="s-thumb"><img src="assets/social/email.png" onerror="this.remove()"></div>
            <span>Email</span><small>Copiar</small>
          </div>
        </div>
      </div>
    </div>
  </header>

  <!-- STATS -->
  <section class="stats card" id="statsSection">
    <div class="stat-chip">All Servers <strong>+6</strong></div>
    <div class="stat-chip">SS Experience <strong>+2 Years</strong></div>
    <div class="stat-chip">SS Manager Experience <strong>1 Year</strong></div>
    <div class="stat-chip">Cases Reviewed <strong>120+</strong></div>
    <div class="stat-chip" id="viewsChip">Views <strong id="viewsValue">—</strong></div>
  </section>

  <!-- SERVERS -->
  <section class="servers card" id="serversSection">
    <h2 class="section-title"><i class="fa-solid fa-server"></i> Servidores</h2>
    <div class="grid" id="serversGrid">
      <article class="srv-card" data-name="DynoPvP" data-year="2023" data-roles="SS Verify y Mod+" data-logo="assets/dynopvp.png">
        <div class="sheen"></div><div class="srv-inner">
          <div class="srv-top">
            <div class="srv-logo"><img src="assets/dynopvp.png" alt="DynoPvP"></div>
            <div class="srv-meta"><h3>DynoPvP</h3><span class="srv-year">2023</span></div>
          </div>
          <p class="srv-roles">SS Verify y Mod+</p>
          <button class="srv-btn" type="button">Ver más</button>
        </div>
      </article>
      <article class="srv-card" data-name="FladePvP" data-year="2024" data-roles="SS Coordinator y Admin" data-logo="assets/fladepvp.png">
        <div class="sheen"></div><div class="srv-inner">
          <div class="srv-top">
            <div class="srv-logo"><img src="assets/fladepvp.png" alt="FladePvP"></div>
            <div class="srv-meta"><h3>FladePvP</h3><span class="srv-year">2024</span></div>
          </div>
          <p class="srv-roles">SS Coordinator y Admin</p>
          <button class="srv-btn" type="button">Ver más</button>
        </div>
      </article>
      <article class="srv-card" data-name="InfernalMC" data-year="2024" data-roles="SS Manager y Manager" data-logo="assets/infernalmc.png">
        <div class="sheen"></div><div class="srv-inner">
          <div class="srv-top">
            <div class="srv-logo"><img src="assets/infernalmc.png" alt="InfernalMC"></div>
            <div class="srv-meta"><h3>InfernalMC</h3><span class="srv-year">2024</span></div>
          </div>
          <p class="srv-roles">SS Manager y Manager</p>
          <button class="srv-btn" type="button">Ver más</button>
        </div>
      </article>
      <article class="srv-card" data-name="AstralMC" data-year="2025" data-roles="SS Trainer y Mod" data-logo="assets/astralmc.png">
        <div class="sheen"></div><div class="srv-inner">
          <div class="srv-top">
            <div class="srv-logo"><img src="assets/astralmc.png" alt="AstralMC"></div>
            <div class="srv-meta"><h3>AstralMC</h3><span class="srv-year">2025</span></div>
          </div>
          <p class="srv-roles">SS Trainer y Mod</p>
          <button class="srv-btn" type="button">Ver más</button>
        </div>
      </article>
      <article class="srv-card now-focus" data-name="DynamicPvP" data-year="Now" data-roles="SS Verify y Mod" data-logo="assets/dynamicpvp.png">
        <div class="sheen"></div><div class="srv-inner">
          <div class="srv-top">
            <div class="srv-logo"><img src="assets/dynamicpvp.png" alt="DynamicPvP"></div>
            <div class="srv-meta"><h3>DynamicPvP</h3><span class="srv-year">Now</span></div>
          </div>
          <p class="srv-roles">SS Verify y Mod</p>
          <button class="srv-btn" type="button">Ver más</button>
        </div>
      </article>
    </div>
  </section>

  <!-- ACHIEVEMENTS -->
  <section class="achievements card alt-achievements" id="achSection">
    <h2 class="section-title"><i class="fa-solid fa-trophy"></i> Logros</h2>
    <div class="ach-lists">
      <div class="ach-box">
        <h3>SS Category</h3>
        <ul>
          <li><i class="fa-solid fa-book"></i> Creación de guías de SS avanzadas.</li>
          <li><i class="fa-solid fa-people-group"></i> Organización y liderazgo de equipos SS.</li>
          <li><i class="fa-solid fa-magnifying-glass"></i> Detección de cheats complejos y ofuscados.</li>
        </ul>
      </div>
      <div class="ach-box">
        <h3>Real Life Category</h3>
        <ul>
          <li><i class="fa-solid fa-medal"></i> Campeón LigaMX Sub 15 2024.</li>
          <li><i class="fa-regular fa-futbol"></i> Ex-Jugador Cruz Azul 2024.</li>
          <li><i class="fa-regular fa-futbol"></i> Ex-Jugador Colegio Madrd 2025.</li>
          <li><i class="fa-regular fa-futbol"></i> Jugador Barceloneta 2025.</li>
          <li><i class="fa-solid fa-trophy"></i> Más de 8 títulos acumulados.</li>
        </ul>
      </div>
    </div>
  </section>

  <!-- MUSIC -->
  <section class="music card">
    <h2 class="section-title"><i class="fa-solid fa-music"></i> Música</h2>
    <div class="music-simple">
      <div id="musicState">Ready: cancion.mp3</div>
      <div class="music-controls-basic">
        <button id="playMusic" class="btn"><i class="fa-solid fa-play"></i> Play</button>
        <button id="volDown" class="btn" title="Vol -"><i class="fa-solid fa-volume-low"></i></button>
        <button id="volUp" class="btn" title="Vol +"><i class="fa-solid fa-volume-high"></i></button>
        <button id="muteMusic" class="btn" title="Mute"><i class="fa-solid fa-volume-xmark"></i></button>
        <button id="reloadAudio" class="btn" title="Recargar audio"><i class="fa-solid fa-rotate-right"></i></button>
      </div>
      <div class="volume-wrap">
        <span style="font-size:.6rem;letter-spacing:.5px">VOL</span>
        <input id="volumeSlider" type="range" min="0" max="100" value="65">
      </div>
      <audio id="bgAudio" preload="auto" loop>
        <source src="assets/music/cancion.mp3" type="audio/mpeg">
        <source src="assets/music/cancion.ogg" type="audio/ogg">
      </audio>
    </div>
  </section>

  <!-- PANELS -->
  <section class="panel-grid">
    <div class="panels-horizontal" id="panelsRow">
      <div class="card mini-panel" id="panelDoing">
        <div class="panel-head">
          <h3>Currently Doing</h3>
          <div style="display:flex;gap:6px;flex-wrap:wrap">
            <button id="startSession" class="btn small" type="button" data-admin><i class="fa-solid fa-play"></i> Start SS</button>
            <button id="endSession" class="btn small danger" type="button" data-admin><i class="fa-solid fa-stop"></i> End SS</button>
            <button id="editDoing" class="btn small" type="button" data-admin><i class="fa-solid fa-pen"></i> Edit</button>
          </div>
        </div>
        <div id="doingContent" class="inline-edit" contenteditable="false">Disponible</div>
      </div>

      <div class="card mini-panel" id="panelObjectives">
        <div class="panel-head">
          <h3>Próximos Objetivos</h3>
          <button id="clearObjectives" class="btn small danger" type="button" title="Vaciar" data-admin><i class="fa-solid fa-trash"></i></button>
        </div>
        <ul id="objectivesList" class="objectives-list"></ul>
        <div class="add-row" data-admin>
          <input id="newObjective" type="text" placeholder="Nuevo objetivo...">
          <button id="addObjective" class="btn small" type="button"><i class="fa-solid fa-plus"></i></button>
        </div>
        <div class="obj-progress" id="objProgress" style="display:none">
          <div class="bar"><span id="objProgBar"></span></div>
          <div class="txt" id="objProgText">0%</div>
        </div>
      </div>

      <div class="card mini-panel" id="panelChangelog">
        <div class="panel-head">
          <h3>Changelog / Updates</h3>
          <button id="clearChangelog" class="btn small danger" type="button" title="Borrar todo" data-admin><i class="fa-solid fa-eraser"></i></button>
        </div>
        <ul id="changelogList" class="changelog-list"></ul>
        <div class="add-row" data-admin>
          <input id="newChange" type="text" placeholder="Nuevo cambio...">
          <button id="addChange" class="btn small" type="button"><i class="fa-solid fa-plus"></i></button>
        </div>
      </div>

      <div class="card mini-panel" id="panelLastUpdate">
        <div class="panel-head">
          <h3>Última Actualización</h3>
          <button id="manualUpdate" class="btn small" type="button" title="Forzar" data-admin><i class="fa-solid fa-clock-rotate-left"></i></button>
        </div>
        <div class="last-update" id="lastUpdateLabel">—</div>
        <div class="last-update" id="lastUpdateRelative" style="opacity:.75"></div>
      </div>
    </div>

    <div style="display:flex;flex-wrap:wrap;gap:20px">
      <div class="card mini-panel" id="panelGallery" style="flex:1 1 300px">
        <div class="panel-head"><h3>Evidencias</h3></div>
        <div class="placeholder-box">PROXIMAMENTE...</div>
      </div>

      <div class="card mini-panel" id="panelTools" style="flex:1 1 300px">
        <div class="panel-head"><h3>Herramientas</h3></div>
        <div class="placeholder-box">PROXIMAMENTE...</div>
      </div>

      <div class="card mini-panel" id="panelViews" style="flex:1 1 300px">
        <div class="panel-head">
          <h3>Visitas</h3>
          <button id="refreshViews" class="btn small" type="button" data-admin title="Sync"><i class="fa-solid fa-rotate"></i></button>
        </div>
        <div style="font-size:.62rem;line-height:1.5;display:flex;flex-direction:column;gap:6px">
          <div><strong>Reales:</strong> <span id="viewsReal">—</span></div>
          <div><strong>Offset:</strong> <span id="viewsOffsetLabel">0</span> <span data-admin style="display:none">(editable abajo)</span></div>
          <div><strong>Total mostrado:</strong> <span id="viewsDisplayed">—</span></div>
          <div data-admin style="display:none;gap:6px;flex-wrap:wrap" id="viewsAdminControls">
            <input id="viewOffset" type="number" placeholder="Nuevo offset" style="flex:1;min-width:90px;padding:6px 8px;border-radius:10px;border:1px solid rgba(255,255,255,.25);background:rgba(255,255,255,.1);color:#fff;font-size:.58rem">
            <button id="applyViewOffset" class="btn small" type="button"><i class="fa-solid fa-floppy-disk"></i></button>
            <button id="addFakeViews" class="btn small" type="button" title="+100 al offset"><i class="fa-solid fa-plus"></i>100</button>
            <button id="resetOffset" class="btn small danger" type="button" title="Reset offset"><i class="fa-solid fa-ban"></i></button>
          </div>
          <small style="opacity:.65">El contador real usa CountAPI y sólo suma 1 por navegador cada 6h.</small>
        </div>
      </div>
    </div>
  </section>

  <footer class="footer">
    © <span id="year"></span> BestArcher_. All rights reserved.
  </footer>
</main>

<!-- SERVER MODAL -->
<dialog id="serverModal" class="modal">
  <form class="modal-box" method="dialog">
    <button class="modal-close" aria-label="Cerrar"><i class="fa-solid fa-xmark"></i></button>
    <div class="modal-head">
      <div class="modal-logo" id="mLogo">S</div>
      <div>
        <h3 id="mTitle">Servidor</h3>
        <p id="mMeta" class="muted" style="font-size:.66rem;letter-spacing:.4px">Año · Roles</p>
      </div>
    </div>
    <div class="modal-content">
      <p class="coming">PROXIMAMENTE...</p>
      <div id="mDesc" class="server-desc"></div>
      <div id="mTags" class="server-tags"></div>
    </div>
    <div class="modal-actions">
      <button class="btn small" value="cancel">Cerrar</button>
    </div>
  </form>
</dialog>

<!-- SETTINGS PANEL -->
<div id="settingsPanel" aria-hidden="true">
  <button id="settingsClose" aria-label="Cerrar"><i class="fa-solid fa-xmark"></i></button>
  <h3>Settings</h3>
  <div class="setting-block">
    <div class="title">Background</div>
    <div class="setting-row" id="bgModeRow">
      <label><input type="radio" name="bgmode" value="car"> Car</label>
      <label><input type="radio" name="bgmode" value="particles"> Particles</label>
      <label><input type="radio" name="bgmode" value="aurora"> Aurora</label>
      <label><input type="radio" name="bgmode" value="image"> Image</label>
    </div>
    <div id="bgImageField" style="margin-top:8px;display:none">
      <input id="bgImageUrl" type="url" placeholder="URL imagen...">
    </div>
    <div style="margin-top:10px" class="setting-row">
      <label><input id="dynamicBgToggle" type="checkbox"> Dynamic BG (Hour)</label>
    </div>
  </div>

  <div class="setting-block">
    <div class="title">Interacción</div>
    <div class="setting-row">
      <label><input id="tiltToggle" type="checkbox"> Tilt</label>
      <label>Cursor
        <select id="cursorStyle" style="background:#121317;color:#fff;border:1px solid rgba(255,255,255,.25);border-radius:8px;padding:4px 6px;font-size:.65rem">
          <option value="minimal">Minimal</option>
          <option value="glow">Glow</option>
          <option value="off">Off</option>
        </select>
      </label>
      <label><input id="cleanToggle" type="checkbox"> Clean Mode</label>
      <label><input id="streamToggle" type="checkbox"> Streaming Mode</label>
      <label><input id="logoFitToggleChk" type="checkbox"> Logos Cover</label>
    </div>
  </div>

  <div class="setting-block">
    <div class="title">Audio</div>
    <div class="setting-row">
      <label><input id="autoplayToggle" type="checkbox"> Autoplay</label>
      <label>Vol <input id="initVol" type="range" min="0" max="100" value="65"></label>
    </div>
  </div>

  <button id="settingsSave" class="btn small">Guardar</button>
</div>

<!-- DEBUG -->
<div id="debugPanel">
  <strong>DEBUG</strong>
  <pre id="debugLog"></pre>
</div>

<!-- TOAST -->
<div id="toast" role="status"></div>

<script>
/* ================= ADMIN MODE ================= */
const ADMIN_HASH = "8d1a714fdc290c65b183a88f7d3b474634579ac6b73b8cdaf704490049591484";
let isAdmin=false;
async function sha256Hex(str){
  const enc=new TextEncoder();
  const buf=await crypto.subtle.digest('SHA-256',enc.encode(str));
  return Array.from(new Uint8Array(buf)).map(b=>b.toString(16).padStart(2,'0')).join('');
}
async function requestAdmin(){
  const pwd=prompt("Password admin:"); if(!pwd) return;
  const h=await sha256Hex(pwd);
  if(h===ADMIN_HASH){isAdmin=true;document.documentElement.classList.add('admin-mode');toast("Admin Mode ON");refreshObjectivesEditButtons();showViewAdmin();}
  else toast("Clave incorrecta");
}
function revokeAdmin(){
  isAdmin=false;document.documentElement.classList.remove('admin-mode');
  toast("Admin Mode OFF");refreshObjectivesEditButtons();hideViewAdmin();
}
document.addEventListener('keydown',e=>{
  if(e.altKey&&e.shiftKey&&e.key.toLowerCase()==='a') requestAdmin();
  if(e.altKey&&e.shiftKey&&e.key.toLowerCase()==='x') revokeAdmin();
});

/* ============== HELPERS ============== */
const $=(s,c=document)=>c.querySelector(s);
const $$=(s,c=document)=>Array.from(c.querySelectorAll(s));
const toast=(m,d=1800)=>{const t=$("#toast");t.textContent=m;t.classList.add('show');clearTimeout(t._t);t._t=setTimeout(()=>t.classList.remove('show'),d);};
const log=(m)=>{ if(!window._debug) return; const l=$("#debugLog"); l.textContent+=m+"\\n"; l.scrollTop=l.scrollHeight; };
function ripple(e,btn){
  const r=document.createElement('span');r.className='ripple';
  const rect=btn.getBoundingClientRect();
  r.style.left=(e.clientX-rect.left)+'px';r.style.top=(e.clientY-rect.top)+'px';
  btn.appendChild(r);r.addEventListener('animationend',()=>r.remove());setTimeout(()=>r.remove(),700);
}

/* SETTINGS STATE */
const STORAGE_KEY='ba_final_custom_settings_v7';
const defaults={bgMode:'car',bgImageUrl:'',tilt:true,cursor:'minimal',musicAutoplay:true,musicInitVol:0.65,dynamicBG:false,cleanMode:false,streamMode:false,logoCover:true};
let settings;
try{settings={...defaults,...JSON.parse(localStorage.getItem(STORAGE_KEY)||'{}')}}catch{settings={...defaults}}
const saveSettings=()=>localStorage.setItem(STORAGE_KEY,JSON.stringify(settings));

/* DATA KEYS */
const K_DOING='ba_doing_text';
const K_OBJECTIVES='ba_objectives_list';
const K_CHANGELOG='ba_changelog_list';
const K_LASTUPDATE='ba_last_update';
const K_SS_SESSION_START='ba_ss_session_start';

/* VIEW COUNTER KEYS */
const K_VIEWS_REAL='ba_views_real';
const K_VIEWS_OFFSET='ba_views_offset';
const K_VIEWS_LAST_HIT='ba_views_last_hit';
const VIEW_NAMESPACE='bestarcher_portfolio';
const VIEW_KEY='global_views_v1';
const VIEW_API='https://api.countapi.xyz';
const VISIT_COOLDOWN_MS=6*60*60*1000; // 6 horas
let viewsReal=Number(localStorage.getItem(K_VIEWS_REAL)||0);
let viewsOffset=Number(localStorage.getItem(K_VIEWS_OFFSET)||0);

function updateViewsUI(){
  $("#viewsReal").textContent=viewsReal;
  $("#viewsOffsetLabel").textContent=viewsOffset;
  $("#viewsDisplayed").textContent=viewsReal+viewsOffset;
  $("#viewsValue").textContent=viewsReal+viewsOffset;
}
function showViewAdmin(){
  $("#viewsAdminControls")?.setAttribute('style','display:flex;gap:6px;flex-wrap:wrap');
}
function hideViewAdmin(){
  $("#viewsAdminControls")?.setAttribute('style','display:none');
}
async function fetchViewCount(hit){
  const url = hit
    ? `${VIEW_API}/hit/${VIEW_NAMESPACE}/${VIEW_KEY}`
    : `${VIEW_API}/get/${VIEW_NAMESPACE}/${VIEW_KEY}`;
  try{
    const res=await fetch(url);
    if(!res.ok) throw new Error(res.status);
    const data=await res.json();
    return data.value;
  }catch(e){
    log('View API error: '+e);
    return null;
  }
}
async function initViews(){
  const lastHit=Number(localStorage.getItem(K_VIEWS_LAST_HIT)||0);
  const now=Date.now();
  const shouldHit = (now-lastHit)>VISIT_COOLDOWN_MS;
  const val = await fetchViewCount(shouldHit);
  if(val!==null){
    viewsReal=val;
    localStorage.setItem(K_VIEWS_REAL,String(viewsReal));
    if(shouldHit) localStorage.setItem(K_VIEWS_LAST_HIT,String(now));
  }
  updateViewsUI();
}
$("#refreshViews")?.addEventListener('click',async()=>{
  if(!isAdmin){toast('Solo admin');return;}
  const val=await fetchViewCount(false);
  if(val!==null){
    viewsReal=val;localStorage.setItem(K_VIEWS_REAL,String(viewsReal));
    toast('Views sincronizado');
  }else toast('Error sync');
  updateViewsUI();
});
$("#applyViewOffset")?.addEventListener('click',()=>{
  if(!isAdmin){toast('Solo admin');return;}
  const v=Number($("#viewOffset").value||0);
  viewsOffset=v;
  localStorage.setItem(K_VIEWS_OFFSET,String(viewsOffset));
  updateViewsUI();
  toast('Offset guardado');
});
$("#addFakeViews")?.addEventListener('click',()=>{
  if(!isAdmin){toast('Solo admin');return;}
  viewsOffset+=100;
  localStorage.setItem(K_VIEWS_OFFSET,String(viewsOffset));
  updateViewsUI();
  toast('+100 offset');
});
$("#resetOffset")?.addEventListener('click',()=>{
  if(!isAdmin){toast('Solo admin');return;}
  if(!confirm('¿Reset offset a 0?'))return;
  viewsOffset=0;
  localStorage.setItem(K_VIEWS_OFFSET,'0');
  updateViewsUI();
  toast('Offset reseteado');
});

/* BACKGROUND */
const bgParticles=$("#bgParticles"), bgAurora=$("#bgAurora"), bgCar=$("#bgCar"), bgImg=$("#bgImage");
let pCtx,pArr=[],pRAF,backgroundApplied=false;
function hideAllBg(){[bgParticles,bgAurora,bgCar,bgImg].forEach(e=>e.style.display='none');cancelAnimationFrame(pRAF);}
function startParticles(){
  bgParticles.style.display='block';
  pCtx=bgParticles.getContext('2d');
  function resize(){
    bgParticles.width=innerWidth;bgParticles.height=innerHeight;
    const count=Math.floor((innerWidth*innerHeight)/26000);
    pArr=new Array(count).fill(0).map(()=>({x:Math.random()*innerWidth,y:Math.random()*innerHeight,vx:(Math.random()-0.5)*0.28,vy:(Math.random()-0.5)*0.28}));
  }
  resize();addEventListener('resize',resize);
  (function frame(){
    pCtx.clearRect(0,0,innerWidth,innerHeight);
    pArr.forEach(p=>{
      p.x+=p.vx;p.y+=p.vy;
      if(p.x<0)p.x+=innerWidth; else if(p.x>innerWidth)p.x-=innerWidth;
      if(p.y<0)p.y+=innerHeight; else if(p.y>innerHeight)p.y-=innerHeight;
      pCtx.fillStyle='rgba(215,225,255,.38)';pCtx.fillRect(p.x,p.y,2.2,2.2);
    });
    pRAF=requestAnimationFrame(frame);
  })();
}
function hourBackground(){
  const h=new Date().getHours();
  if(h>=6&&h<12)return'particles';
  if(h>=12&&h<18)return'aurora';
  if(h>=18&&h<=23)return'car';
  return'car';
}
function applyBackground(force=false){
  if(!force && backgroundApplied && !settings.dynamicBG) return;
  hideAllBg();
  let mode=settings.bgMode;
  if(settings.dynamicBG) mode=hourBackground();
  if(mode==='car') bgCar.style.display='block';
  else if(mode==='particles') startParticles();
  else if(mode==='aurora') bgAurora.style.display='block';
  else if(mode==='image'){
    bgImg.style.display='block';
    bgImg.style.backgroundImage=settings.bgImageUrl?`url("${settings.bgImageUrl}")`:'none';
  }
  backgroundApplied=true;
}

/* CURSOR */
const cursorDot=document.createElement('div'), cursorRing=document.createElement('div');
cursorDot.className='cursor-dot';cursorRing.className='cursor-ring';
function injectCursor(){document.body.appendChild(cursorDot);document.body.appendChild(cursorRing);}
function applyCursor(style){
  if(style==='off'||!matchMedia('(pointer:fine)').matches){cursorDot.style.display='none';cursorRing.style.display='none';return;}
  cursorDot.style.cssText='position:fixed;top:0;left:0;width:6px;height:6px;background:#fff;border-radius:50%;pointer-events:none;z-index:1000;display:block;transform:translate(-50%,-50%)';
  cursorRing.style.cssText='position:fixed;top:0;left:0;width:38px;height:38px;border:2px solid rgba(255,255,255,.35);border-radius:50%;pointer-events:none;z-index:1000;display:block;transform:translate(-50%,-50%);transition:width .25s,height .25s,border-color .25s';
  cursorRing.classList.toggle('glow',style==='glow');
  if(!cursorDot.dataset.started){
    cursorDot.dataset.started='1';
    let mx=innerWidth/2,my=innerHeight/2,rx=mx,ry=my;
    (function loop(){
      rx+=(mx-rx)*0.18;ry+=(my-ry)*0.18;
      cursorDot.style.transform=`translate(${mx}px,${my}px)`;
      cursorRing.style.transform=`translate(${rx}px,${ry}px)`;
      requestAnimationFrame(loop);
    })();
    addEventListener('mousemove',e=>{mx=e.clientX;my=e.clientY;},{passive:true});
    addEventListener('mousedown',()=>{cursorRing.style.width='56px';cursorRing.style.height='56px';});
    addEventListener('mouseup',()=>{cursorRing.style.width='38px';cursorRing.style.height='38px';});
  }
}

/* TILT */
function applyTilt(on){
  $$('.srv-card').forEach(el=>{
    el.onmousemove=null;el.onmouseleave=null;el.style.transform='';
    if(!on||!matchMedia('(pointer:fine)').matches||document.body.classList.contains('streaming-mode'))return;
    let af=null,tx=0,ty=0,cx=0,cy=0;
    function anim(){af=null;cx+=(tx-cx)*0.18;cy+=(ty-cy)*0.18;el.style.transform=`perspective(900px) rotateX(${cx}deg) rotateY(${cy}deg)`;if(Math.abs(cx-tx)>0.05||Math.abs(cy-ty)>0.05)af=requestAnimationFrame(anim);}
    el.addEventListener('mousemove',e=>{
      const r=el.getBoundingClientRect(),x=(e.clientX-r.left)/r.width,y=(e.clientY-r.top)/r.height;
      tx=(0.5-y)*9;ty=(x-0.5)*9;if(!af)af=requestAnimationFrame(anim);
    });
    el.addEventListener('mouseleave',()=>{tx=ty=0;if(!af)af=requestAnimationFrame(anim);});
  });
}

/* SERVER MODAL */
const serverDetails={
  "DynoPvP":{desc:"Moderación y SS enfocada en jugadores competitivos.",tags:["SS","Mod","Verify"]},
  "FladePvP":{desc:"Coordinación y administración de procesos SS internos.",tags:["Admin","Coord"]},
  "InfernalMC":{desc:"Gestión de equipo y optimización de revisiones.",tags:["Manager","SS Lead"]},
  "AstralMC":{desc:"Entrenamiento de nuevos verificadores.",tags:["Trainer","Mod"]},
  "DynamicPvP":{desc:"Verificaciones activas y soporte rápido.",tags:["Verify","Support"]}
};
const serverModal=$("#serverModal");
const mTitle=$("#mTitle"), mMeta=$("#mMeta"), mLogo=$("#mLogo"), mDesc=$("#mDesc"), mTags=$("#mTags");
function openServer(card){
  const d=card.dataset;
  const info=serverDetails[d.name]||{desc:"Sin datos aún.",tags:["Soon"]};
  mTitle.textContent=d.name||'Servidor';
  mMeta.textContent=`${d.year||'—'} · ${d.roles||'—'}`;
  mLogo.textContent=(d.name||'S').slice(0,2);
  if(d.logo){mLogo.style.backgroundImage=`url("${d.logo}")`;mLogo.style.backgroundSize='cover';mLogo.style.backgroundPosition='center';}
  else mLogo.style.backgroundImage='';
  mDesc.textContent=info.desc;
  mTags.innerHTML=info.tags.map(t=>`<span class="server-tag">${t}</span>`).join('');
  document.body.classList.add('modal-open');
  serverModal.showModal?.();
}
$('.modal-close',serverModal)?.addEventListener('click',e=>{e.preventDefault();serverModal.close();document.body.classList.remove('modal-open');});
serverModal.addEventListener('close',()=>document.body.classList.remove('modal-open'));
serverModal.addEventListener('click',e=>{if(e.target===serverModal){serverModal.close();document.body.classList.remove('modal-open');}});
$$('.srv-card').forEach(c=>{
  c.addEventListener('click',()=>openServer(c));
  c.querySelector('.srv-btn')?.addEventListener('click',e=>{e.stopPropagation();openServer(c);});
});
if(!HTMLDialogElement.prototype.showModal){
  document.querySelectorAll('dialog').forEach(d=>{
    d.showModal=function(){d.classList.add('force-open')};
    d.close=function(){d.classList.remove('force-open')};
  });
  const st=document.createElement('style');
  st.textContent=`dialog.force-open{display:flex!important;position:fixed;inset:0;margin:0;padding:0;align-items:center;justify-content:center;background:rgba(0,0,0,.55)}`;
  document.head.appendChild(st);
}

/* MUSIC */
const audioEl=$("#bgAudio");
const playBtn=$("#playMusic"), volDown=$("#volDown"), volUp=$("#volUp"), muteBtn=$("#muteMusic"),
      volSlider=$("#volumeSlider"), musicState=$("#musicState"), reloadBtn=$("#reloadAudio");
function updateMusicState(){
  const src=(audioEl.currentSrc.split('/').pop()||'cancion.mp3');
  musicState.textContent=(audioEl.paused?'Pausado: ':'Reproduciendo: ')+src+(audioEl.muted?' (Muted)':'');
}
audioEl.addEventListener('error',()=>toast('Error cargando cancion.mp3'));
playBtn.addEventListener('click',()=>{
  if(audioEl.paused){
    audioEl.play().then(()=>{playBtn.innerHTML='<i class="fa-solid fa-pause"></i> Pause';updateMusicState();})
      .catch(()=>toast('Reproducción bloqueada'));
  }else{
    audioEl.pause();playBtn.innerHTML='<i class="fa-solid fa-play"></i> Play';updateMusicState();
  }
});
reloadBtn.addEventListener('click',()=>{
  audioEl.pause();audioEl.currentTime=0;audioEl.load();toast('Audio recargado');updateMusicState();
});
volDown.addEventListener('click',()=>{audioEl.volume=Math.max(0, +(audioEl.volume.toFixed(2))-0.1);volSlider.value=Math.round(audioEl.volume*100);updateMusicState();});
volUp.addEventListener('click',()=>{audioEl.volume=Math.min(1, +(audioEl.volume.toFixed(2))+0.1);volSlider.value=Math.round(audioEl.volume*100);updateMusicState();});
muteBtn.addEventListener('click',()=>{
  audioEl.muted=!audioEl.muted;
  muteBtn.innerHTML=audioEl.muted?'<i class="fa-solid fa-volume-xmark"></i>':'<i class="fa-solid fa-volume-high"></i>';
  updateMusicState();
});
volSlider.addEventListener('input',()=>{
  audioEl.volume=(volSlider.value|0)/100;
  audioEl.muted=audioEl.volume===0;
  muteBtn.innerHTML=audioEl.muted?'<i class="fa-solid fa-volume-xmark"></i>':'<i class="fa-solid fa-volume-high"></i>';
  updateMusicState();
});
audioEl.addEventListener('play',updateMusicState);
audioEl.addEventListener('pause',updateMusicState);

/* CURRENTLY DOING */
const doingEl=$("#doingContent"), editDoing=$("#editDoing");
function loadDoing(){doingEl.textContent=localStorage.getItem(K_DOING)||'Disponible';}
function saveDoing(){localStorage.setItem(K_DOING, doingEl.textContent.trim()||'Disponible');updateLastUpdate();}
editDoing.addEventListener('click',()=>{
  if(!isAdmin){toast('Solo admin');return;}
  const editing=doingEl.getAttribute('contenteditable')==='true';
  if(!editing){
    doingEl.setAttribute('contenteditable','true');doingEl.focus();
    editDoing.innerHTML='<i class="fa-solid fa-floppy-disk"></i> Save';
  }else{
    doingEl.setAttribute('contenteditable','false');saveDoing();
    editDoing.innerHTML='<i class="fa-solid fa-pen"></i> Edit';
  }
});

/* SS SESSION TIMER */
const startSessionBtn=$("#startSession"), endSessionBtn=$("#endSession");
let sessionStart=null;
function loadSession(){
  const stored=localStorage.getItem(K_SS_SESSION_START);
  if(stored) sessionStart=+stored;
}
function startSession(){
  if(!isAdmin){toast('Solo admin');return;}
  if(sessionStart){toast('Sesión ya activa');return;}
  sessionStart=Date.now();
  localStorage.setItem(K_SS_SESSION_START,String(sessionStart));
  toast('SS Session iniciada');
}
function endSession(){
  if(!isAdmin){toast('Solo admin');return;}
  if(!sessionStart){toast('No hay sesión');return;}
  const duration=Date.now()-sessionStart;
  const mins=Math.floor(duration/60000);
  addChangelogEntry(`Sesión SS finalizada (${mins} min)`);
  localStorage.removeItem(K_SS_SESSION_START);
  sessionStart=null;
  toast('SS Session terminada');
  updateLastUpdate();
}
startSessionBtn.addEventListener('click',startSession);
endSessionBtn.addEventListener('click',endSession);
function renderSessionTicker(){
  if(sessionStart){
    const diff=Date.now()-sessionStart;
    const m=Math.floor(diff/60000);const s=Math.floor((diff/1000)%60);
    doingEl.dataset.base=doingEl.dataset.base||doingEl.textContent;
    doingEl.textContent=(doingEl.dataset.base)+' · SS '+String(m).padStart(2,'0')+':'+String(s).padStart(2,'0');
  }
  requestAnimationFrame(renderSessionTicker);
}

/* OBJECTIVES */
const objList=$("#objectivesList"), objInput=$("#newObjective"), objAdd=$("#addObjective"), objClear=$("#clearObjectives");
const objProgressWrap=$("#objProgress"), objProgBar=$("#objProgBar"), objProgText=$("#objProgText");
function loadObjectives(){
  objList.innerHTML='';
  const arr=JSON.parse(localStorage.getItem(K_OBJECTIVES)||'[]');
  arr.forEach(o=>renderObjective(o));
  updateObjectivesProgress();
}
function saveObjectives(){
  const data=[...objList.children].map(li=>({text:li.dataset.text,done:li.classList.contains('done')}));
  localStorage.setItem(K_OBJECTIVES,JSON.stringify(data));
  updateObjectivesProgress();
}
function renderObjective(o){
  const li=document.createElement('li');
  li.dataset.text=o.text;
  if(o.done) li.classList.add('done');
  li.innerHTML=`<span>${o.text}</span>${isAdmin?'<button class="btn small icon danger" type="button" title="Eliminar"><i class="fa-solid fa-xmark"></i></button>':''}`;
  li.addEventListener('click',e=>{
    if(!isAdmin)return;
    if(e.target.closest('button')) return;
    li.classList.toggle('done'); saveObjectives(); updateLastUpdate();
  });
  if(isAdmin) li.querySelector('button')?.addEventListener('click',()=>{li.remove();saveObjectives();updateLastUpdate();});
  objList.appendChild(li);
}
function refreshObjectivesEditButtons(){loadObjectives();}
objAdd?.addEventListener('click',()=>{
  if(!isAdmin){toast('Solo admin');return;}
  const v=objInput.value.trim(); if(!v)return;
  renderObjective({text:v,done:false}); saveObjectives(); objInput.value=''; updateLastUpdate();
});
objInput?.addEventListener('keydown',e=>{if(e.key==='Enter')objAdd.click();});
objClear?.addEventListener('click',()=>{
  if(!isAdmin){toast('Solo admin');return;}
  if(!confirm('¿Vaciar objetivos?'))return;
  localStorage.removeItem(K_OBJECTIVES);
  loadObjectives();
  updateLastUpdate();
});
function updateObjectivesProgress(){
  const arr=JSON.parse(localStorage.getItem(K_OBJECTIVES)||'[]');
  if(!arr.length){objProgressWrap.style.display='none';return;}
  objProgressWrap.style.display='flex';
  const done=arr.filter(o=>o.done).length;
  const pct=Math.round(done/arr.length*100);
  objProgBar.style.width=pct+'%';
  objProgText.textContent=pct+'% ('+done+'/'+arr.length+')';
}

/* CHANGELOG */
const clList=$("#changelogList"), clInput=$("#newChange"), clAdd=$("#addChange"), clClear=$("#clearChangelog");
function loadChangelog(){
  clList.innerHTML='';
  const arr=JSON.parse(localStorage.getItem(K_CHANGELOG)||'[]').sort((a,b)=>b.time-a.time);
  arr.forEach(it=>renderChange(it));
}
function saveChangelog(arr){localStorage.setItem(K_CHANGELOG,JSON.stringify(arr));}
function addChangelogEntry(text){
  const arr=JSON.parse(localStorage.getItem(K_CHANGELOG)||'[]');
  arr.push({text,time:Date.now()});saveChangelog(arr);loadChangelog();
}
function renderChange(it){
  const li=document.createElement('li');
  li.innerHTML=`<span>${it.text}</span><span class="cl-date">${new Date(it.time).toLocaleString()}</span>`;
  clList.appendChild(li);
}
clAdd?.addEventListener('click',()=>{
  if(!isAdmin){toast('Solo admin');return;}
  const v=clInput.value.trim(); if(!v)return;
  addChangelogEntry(v);clInput.value='';updateLastUpdate();
});
clInput?.addEventListener('keydown',e=>{if(e.key==='Enter')clAdd.click();});
clClear?.addEventListener('click',()=>{
  if(!isAdmin){toast('Solo admin');return;}
  if(!confirm('¿Borrar todo el changelog?'))return;
  localStorage.removeItem(K_CHANGELOG);loadChangelog();
});

/* LAST UPDATE */
const lastUpdateEl=$("#lastUpdateLabel"), lastUpdateRel=$("#lastUpdateRelative"), manualUpdate=$("#manualUpdate");
function loadLastUpdate(){
  const t=localStorage.getItem(K_LASTUPDATE);
  if(t) lastUpdateEl.textContent=new Date(+t).toLocaleString();
  else {lastUpdateEl.textContent='—';lastUpdateRel.textContent='';}
}
function updateLastUpdate(){
  const now=Date.now();
  localStorage.setItem(K_LASTUPDATE,String(now));
  loadLastUpdate();
}
manualUpdate?.addEventListener('click',()=>{
  if(!isAdmin){toast('Solo admin');return;}
  updateLastUpdate();toast('Timestamp actualizado');
});
function relativeFormat(ts){
  const diff=Date.now()-ts;
  const s=Math.floor(diff/1000);
  if(s<60)return'hace '+s+'s';
  const m=Math.floor(s/60);
  if(m<60)return'hace '+m+'m';
  const h=Math.floor(m/60);
  if(h<24)return'hace '+h+'h';
  const d=Math.floor(h/24);
  return 'hace '+d+'d';
}
function tickRelative(){
  const t=localStorage.getItem(K_LASTUPDATE);
  if(t) lastUpdateRel.textContent=relativeFormat(+t);
  requestAnimationFrame(tickRelative);
}

/* MODES */
const cleanBtn=$("#toggleClean"), streamBtn=$("#toggleStream"), modeBadge=$("#modeBadge"), logoFitBtn=$("#toggleLogoFit"), logoFitChk=$("#logoFitToggleChk");
function applyLogoFit(){
  document.body.classList.toggle('server-cover-mode', !!settings.logoCover);
  logoFitBtn.classList.toggle('is-active', settings.logoCover);
  if(logoFitChk) logoFitChk.checked=settings.logoCover;
}
function applyModes(){
  document.body.classList.toggle('clean-mode', settings.cleanMode);
  document.body.classList.toggle('streaming-mode', settings.streamMode);
  if(settings.streamMode){
    audioEl.muted=true;
    playBtn.innerHTML='<i class="fa-solid fa-play"></i> Play';
    modeBadge.style.display='block';
  }else{
    modeBadge.style.display='none';
    if(!audioEl.paused) audioEl.muted=false;
  }
  applyTilt(settings.tilt);
}
function refreshModeButtons(){
  cleanBtn.classList.toggle('is-active', settings.cleanMode);
  streamBtn.classList.toggle('is-active', settings.streamMode);
}
cleanBtn.addEventListener('click',()=>{
  settings.cleanMode=!settings.cleanMode;saveSettings();applyModes();refreshModeButtons();
  toast(settings.cleanMode?'Clean Mode ON':'Clean Mode OFF');
});
streamBtn.addEventListener('click',()=>{
  settings.streamMode=!settings.streamMode;saveSettings();applyModes();refreshModeButtons();
  toast(settings.streamMode?'Stream Mode ON':'Stream Mode OFF');
});
logoFitBtn.addEventListener('click',()=>{
  settings.logoCover=!settings.logoCover;saveSettings();applyLogoFit();
  toast(settings.logoCover?'Logos COVER':'Logos CONTAIN');
});
logoFitChk?.addEventListener('change',()=>{
  settings.logoCover=logoFitChk.checked;saveSettings();applyLogoFit();
});

/* SETTINGS PANEL */
const settingsPanel=$("#settingsPanel");
$("#openSettings").addEventListener('click',()=>{populateSettingsPanel();settingsPanel.classList.add('open');});
$("#settingsClose").addEventListener('click',()=>settingsPanel.classList.remove('open'));
document.addEventListener('keydown',e=>{
  if(e.key==='Escape'&&settingsPanel.classList.contains('open')) settingsPanel.classList.remove('open');
});
function populateSettingsPanel(){
  $$('input[name="bgmode"]').forEach(r=>r.checked=(r.value===settings.bgMode));
  $("#bgImageUrl").value=settings.bgImageUrl;
  $("#bgImageField").style.display=settings.bgMode==='image'?'block':'none';
  $("#tiltToggle").checked=settings.tilt;
  $("#cursorStyle").value=settings.cursor;
  $("#autoplayToggle").checked=settings.musicAutoplay;
  $("#initVol").value=Math.round(settings.musicInitVol*100);
  $("#dynamicBgToggle").checked=settings.dynamicBG;
  $("#cleanToggle").checked=settings.cleanMode;
  $("#streamToggle").checked=settings.streamMode;
  if(logoFitChk) logoFitChk.checked=settings.logoCover;
}
$("#bgModeRow").addEventListener('change',e=>{
  if(e.target.name==='bgmode') $("#bgImageField").style.display=e.target.value==='image'?'block':'none';
});
$("#settingsSave").addEventListener('click',()=>{
  settings.bgMode=$$('input[name="bgmode"]').find(r=>r.checked)?.value||'car';
  settings.bgImageUrl=$("#bgImageUrl").value.trim();
  settings.tilt=$("#tiltToggle").checked;
  settings.cursor=$("#cursorStyle").value;
  settings.musicAutoplay=$("#autoplayToggle").checked;
  settings.musicInitVol=(Number($("#initVol").value)||65)/100;
  settings.dynamicBG=$("#dynamicBgToggle").checked;
  settings.cleanMode=$("#cleanToggle").checked;
  settings.streamMode=$("#streamToggle").checked;
  settings.logoCover=logoFitChk?logoFitChk.checked:settings.logoCover;
  saveSettings();
  audioEl.volume=settings.musicInitVol;
  applyBackground(true);
  applyCursor(settings.cursor);
  applyModes();
  refreshModeButtons();
  applyLogoFit();
  toast('Configuración guardada');
  settingsPanel.classList.remove('open');
});

/* COPY / RIPPLE */
document.addEventListener('click',e=>{
  const btn=e.target.closest('.btn,.icon-btn,.mode-btn');
  if(btn) ripple(e,btn);
  const cp=e.target.closest('[data-copy]');
  if(cp){
    navigator.clipboard?.writeText(cp.getAttribute('data-copy')||'')
      .then(()=>toast('Copiado'))
      .catch(()=>toast('Error copiar'));
  }
});

/* DEBUG */
const debugParam=new URLSearchParams(location.search).has('debug');
window._debug=debugParam;
if(window._debug) $("#toggleDebug").hidden=false;
$("#toggleDebug").addEventListener('click',()=>$("#debugPanel").classList.toggle('show'));

/* LOGO FALLBACK */
$$('.srv-logo img').forEach(img=>{
  img.addEventListener('error',()=>{
    const parent=img.parentElement;
    parent.classList.add('logo-fallback');
    parent.innerHTML='<span>'+ (img.alt?.[0]||'?') +'</span>';
  });
});

/* CLEAN stray dots */
(function cleanDots(){
  const junk=/^([.·•])+$/;const walker=document.createTreeWalker(document.body,NodeFilter.SHOW_TEXT,null);
  const kill=[];while(walker.nextNode()){const n=walker.currentNode;if(junk.test(n.textContent.trim())) kill.push(n);}
  kill.forEach(n=>n.remove());
})();

/* ENTRY */
$("#year").textContent=new Date().getFullYear();
$("#entry").addEventListener('click',()=>{
  $("#entry").classList.add('fade-out');
  setTimeout(()=>$("#entry").remove(),560);
  applyBackground(true);
  injectCursor();
  applyCursor(settings.cursor);
  applyTilt(settings.tilt);
  audioEl.volume=settings.musicInitVol;
  if(settings.musicAutoplay){
    audioEl.play().then(()=>{playBtn.innerHTML='<i class="fa-solid fa-pause"></i> Pause';updateMusicState();})
      .catch(()=>toast('Autoplay bloqueado'));
  }else updateMusicState();
  // Iniciar contador de vistas tras entrar
  initViews();
},{once:true});

/* LAST UPDATE RELATIVE LOOP */
function loopRelative(){
  const t=localStorage.getItem(K_LASTUPDATE);
  if(t) lastUpdateRel.textContent=relativeFormat(+t);
  requestAnimationFrame(loopRelative);
}

/* INIT */
function init(){
  if(['aurora','image'].includes(settings.bgMode) || settings.dynamicBG) applyBackground(true);
  loadDoing();
  loadObjectives();
  loadChangelog();
  loadLastUpdate();
  loadSession();
  applyModes();
  refreshModeButtons();
  applyLogoFit();
  audioEl.volume=settings.musicInitVol;
  updateMusicState();
  renderSessionTicker();
  updateViewsUI(); // muestra placeholder si aún no se hizo hit
  loopRelative();
}
init();
</script>
</body>

</html>
