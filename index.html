<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8">
<title>BestArcher_ | Portfolio</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="color-scheme" content="dark">
<meta name="theme-color" content="#060607">
<link rel="icon" href="assets/profile.jpg">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet"
  href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css"
  crossorigin="anonymous" referrerpolicy="no-referrer" />
<style>
:root{
  --bg:#0A0A0B;--text:#F2F2F6;--muted:#A6A6BF;
  --card:rgba(255,255,255,.055);--border:rgba(255,255,255,.14);
  --grad:linear-gradient(180deg,rgba(255,255,255,.18),rgba(255,255,255,.06));
  --hover:linear-gradient(180deg,rgba(255,255,255,.3),rgba(255,255,255,.12));
  --radius:26px;--focus:rgba(255,255,255,.45);
  font-family:'Poppins',system-ui,sans-serif;
}
*{box-sizing:border-box;margin:0;padding:0}
body{background:var(--bg);color:var(--text);-webkit-font-smoothing:antialiased;overflow-x:hidden}
a{text-decoration:none;color:inherit}
img{display:block;max-width:100%}
ul,li{list-style:none;margin:0;padding:0}
:focus-visible{outline:2px solid var(--focus);outline-offset:3px;border-radius:8px}
::-webkit-scrollbar{width:10px;height:10px}::-webkit-scrollbar-thumb{background:#252629;border-radius:20px}

/* BACKGROUNDS */
.bg{position:fixed;inset:0;z-index:-3;background:#060607}
#bgParticles{position:absolute;inset:0;display:none}
#bgAurora{position:absolute;inset:0;display:none;pointer-events:none}
.aur{position:absolute;width:70vmax;height:70vmax;filter:blur(70px);opacity:.34;transform:translate(-50%,-50%);
background:
 radial-gradient(circle at 30% 30%,#34363a,transparent 60%),
 radial-gradient(circle at 65% 72%,#3d3f43,transparent 60%),
 radial-gradient(circle at 50% 10%,#4a4c50,transparent 55%);
mix-blend-mode:screen;animation:aur 24s ease-in-out infinite}
@keyframes aur{0%,100%{transform:translate(-50%,-50%) scale(1)}50%{transform:translate(-48%,-52%) scale(1.03)}}
#a1{top:20%;left:20%}#a2{top:70%;left:80%;animation-delay:5s}#a3{top:52%;left:52%;animation-delay:10s}
#bgCar{position:absolute;inset:0;display:none;overflow:hidden;background:#040506}
#bgCar .car-img{position:absolute;inset:0;background:url("assets/backgrounds/car.jpg") center/cover no-repeat;opacity:.44;filter:contrast(1.07) brightness(.87)}
#bgCar .wash{position:absolute;inset:0;
 background:
   radial-gradient(circle at 70% 55%,rgba(255,0,0,.28),transparent 60%),
   radial-gradient(circle at 35% 40%,rgba(0,160,110,.25),transparent 65%),
   linear-gradient(#050607,#0a0d11);mix-blend-mode:screen}
#bgCar .vignette{position:absolute;inset:0;background:radial-gradient(circle at 50% 55%,rgba(0,0,0,0) 0%,rgba(0,0,0,.42) 55%,#000 100%)}
.smoke{position:absolute;width:160%;height:160%;top:50%;left:50%;transform:translate(-50%,-50%);
background:
 radial-gradient(circle at 30% 40%,rgba(255,255,255,.07),transparent 60%),
 radial-gradient(circle at 70% 60%,rgba(255,255,255,.06),transparent 65%);
filter:blur(80px);mix-blend-mode:screen;animation:smk 60s linear infinite;opacity:.5}
.smoke.s2{animation-direction:reverse;animation-duration:70s;opacity:.36}
.smoke.s3{animation-duration:82s;opacity:.41}
@keyframes smk{0%{transform:translate(-50%,-50%) rotate(0deg) scale(1)}50%{transform:translate(-50%,-52%) rotate(180deg) scale(1.05)}100%{transform:translate(-50%,-50%) rotate(360deg) scale(1)}}
.bg-image{position:absolute;inset:0;background-size:cover;background-position:center;background-repeat:no-repeat;display:none;opacity:.33;filter:grayscale(.15) contrast(1.05)}

/* ENTRY */
.entry{position:fixed;inset:0;z-index:50;display:flex;align-items:center;justify-content:center;
background:radial-gradient(circle at 50% 45%,rgba(255,255,255,.085),rgba(0,0,0,.88));backdrop-filter:blur(18px);cursor:pointer}
.entry-box{position:relative;padding:60px 78px;border:1px solid rgba(255,255,255,.16);border-radius:48px;background:rgba(255,255,255,.07);text-align:center}
.entry-title{margin:0 0 16px;font-size:clamp(2.6rem,4.2vw,3.9rem);font-weight:700;letter-spacing:.9px}
.entry-sub{margin:0;font-size:.82rem;letter-spacing:4px;color:#d5d5dc}
.entry-ring{position:absolute;inset:-2px;border-radius:inherit;background:
conic-gradient(from 0deg,rgba(255,255,255,.22),transparent 40%,transparent 60%,rgba(255,255,255,.22));
animation:spin 3s linear infinite;mix-blend-mode:overlay;opacity:.7}
.fade-out{animation:fout .55s ease forwards}@keyframes fout{to{opacity:0;visibility:hidden}}
body.modal-open{overflow:hidden}

/* TOPBAR */
.topbar{position:sticky;top:0;z-index:40;display:flex;justify-content:space-between;align-items:center;
padding:10px 22px;background:rgba(15,16,20,.55);backdrop-filter:blur(18px) saturate(170%);border-bottom:1px solid rgba(255,255,255,.1)}
.brand{display:flex;align-items:center;gap:12px;font-weight:700;font-size:1.07rem}

/* PAGE & CARDS */
.page{display:flex;flex-direction:column;gap:30px;align-items:center;padding:26px 18px 80px}
.card{width:100%;max-width:1180px;background:var(--card);border:1px solid var(--border);border-radius:var(--radius);
backdrop-filter:blur(20px) saturate(165%);padding:34px 36px;position:relative;overflow:hidden}
.card:after{content:"";position:absolute;inset:-1px;padding:1px;border-radius:inherit;background:
linear-gradient(140deg,rgba(255,255,255,.12),transparent);
-webkit-mask:linear-gradient(#000 0 0) content-box,linear-gradient(#000 0 0);-webkit-mask-composite:xor;mask-composite:exclude;pointer-events:none}

/* HERO */
.hero{display:grid;grid-template-columns:230px 1fr;gap:42px}
@media (max-width:880px){.hero{grid-template-columns:1fr}}
.avatar-wrap{position:relative;width:190px}
.avatar{width:190px;height:190px;border-radius:50%;border:5px solid rgba(255,255,255,.55);object-fit:cover;
box-shadow:0 0 0 7px rgba(255,255,255,.09),0 20px 50px -12px rgba(0,0,0,.75)}
.name{margin:0 0 16px;font-size:clamp(2.35rem,2.6vw + 1rem,3.15rem);font-weight:700;display:flex;align-items:center;gap:10px;letter-spacing:.65px;flex-wrap:wrap}
.status-dot-inline{width:12px;height:12px;border-radius:50%;background:#2fd06d;border:2px solid #0c0f12;box-shadow:0 0 4px #2fd06d,0 0 10px #2fd06d;display:inline-block}
.bio{margin:8px 0 34px;color:var(--muted);line-height:1.55;max-width:74ch;letter-spacing:.25px}

/* SOCIAL */
.social-hub{display:flex;flex-direction:column;gap:26px}
.social-icons{display:flex;gap:12px;flex-wrap:wrap;background:rgba(255,255,255,.07);padding:16px 18px;border:1px solid rgba(255,255,255,.13);border-radius:24px}
.icon-btn{width:46px;height:46px;display:grid;place-items:center;border-radius:16px;background:var(--grad);border:1px solid rgba(255,255,255,.18);color:#fff;cursor:pointer;transition:transform .26s,background .26s}
.icon-btn:hover{transform:translateY(-5px);background:var(--hover)}
.icon-btn:active{transform:translateY(-2px)}
.social-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(168px,1fr));gap:18px;font-size:0}
.s-card{font-size:initial;position:relative;padding:16px 16px 14px;border:1px solid rgba(255,255,255,.15);border-radius:22px;
background:linear-gradient(175deg,rgba(255,255,255,.08),rgba(255,255,255,.03));display:flex;flex-direction:column;gap:8px;
font-size:.85rem;font-weight:600;cursor:pointer;transition:transform .26s,border-color .28s,background .35s}
.s-card small{font-size:.58rem;color:#d6d6dc;letter-spacing:.55px;text-transform:uppercase}
.s-card:hover{transform:translateY(-6px);border-color:rgba(255,255,255,.3);background:linear-gradient(175deg,rgba(255,255,255,.15),rgba(255,255,255,.05))}
.s-thumb{width:48px;height:48px;border-radius:15px;overflow:hidden;background:rgba(255,255,255,.1);display:flex;align-items:center;justify-content:center}

/* STATS */
.stats{display:flex;flex-wrap:wrap;gap:22px;padding:4px 2px 2px;justify-content:center}
.stat-chip{background:rgba(255,255,255,.075);border:1px solid rgba(255,255,255,.17);padding:14px 18px;border-radius:16px;font-size:.82rem;font-weight:600;letter-spacing:.4px;min-width:160px;text-align:center;display:flex;flex-direction:column;align-items:center;justify-content:center;cursor:default}
.stat-chip.dragging{opacity:.35;outline:2px dashed rgba(255,255,255,.4)}
.stat-chip[contenteditable="true"]{outline:2px solid rgba(255,255,255,.5)}

/* SECTION TITLE */
.section-title{margin:0 0 24px;font-size:1.26rem;letter-spacing:.55px;font-weight:600;display:flex;align-items:center;gap:10px;cursor:default}
.section-title[contenteditable="true"]{outline:2px solid rgba(255,255,255,.5)}

/* DRAG highlight */
.owner-mode [data-owner-block]{position:relative}
.owner-mode [data-owner-block]:hover{outline:1px dashed rgba(255,255,255,.35)}
.owner-mode [data-owner-block].dragging{opacity:.35;outline:2px dashed rgba(255,255,255,.55)}

/* SERVERS */
.servers .grid{display:flex;flex-wrap:wrap;gap:22px}
.srv-card{position:relative;border-radius:24px;background:rgba(255,255,255,.075);border:1px solid rgba(255,255,255,.16);width:232px;min-height:205px;display:flex;flex-direction:column;cursor:pointer;overflow:hidden;
transition:transform .28s,border-color .28s,box-shadow .4s}
.srv-card.dragging{opacity:.35;outline:2px dashed rgba(255,255,255,.4)}
.srv-card:hover{transform:translateY(-6px);border-color:rgba(255,255,255,.3);box-shadow:0 14px 40px -12px rgba(0,0,0,.75)}
.srv-card.now-focus{box-shadow:0 0 0 2px rgba(120,200,255,.65),0 0 22px -4px rgba(120,200,255,.85)}
.sheen{position:absolute;inset:0;background:linear-gradient(125deg,transparent 35%,rgba(255,255,255,.15) 52%,transparent 70%);opacity:0;transition:opacity .45s;pointer-events:none}
.srv-card:hover .sheen{opacity:1}
.srv-inner{display:flex;flex-direction:column;padding:16px 18px 14px;flex:1}
.srv-top{display:flex;align-items:center;gap:14px}
.srv-logo{width:72px;height:72px;border-radius:20px;background:#101114;display:flex;align-items:center;justify-content:center;overflow:hidden;border:1px solid rgba(255,255,255,.18);position:relative}
.srv-logo img{width:100%;height:100%;object-fit:cover;display:block;transition:transform .4s}
.srv-card:hover .srv-logo img{transform:scale(1.07)}
.srv-meta h3{margin:0;font-size:.95rem;font-weight:700;letter-spacing:.3px;cursor:default}
.srv-meta h3[contenteditable="true"]{outline:2px solid rgba(255,255,255,.5)}
.srv-year{color:var(--muted);font-size:.63rem;letter-spacing:.5px}
.srv-roles{margin:10px 0 0;color:#dadade;font-size:.68rem;line-height:1.45;letter-spacing:.32px;flex:1;cursor:default;white-space:pre-line}
.srv-roles[contenteditable="true"]{outline:2px solid rgba(255,255,255,.5)}
.srv-btn{margin-top:12px;border:1px solid rgba(255,255,255,.25);background:var(--grad);color:#fff;height:42px;border-radius:14px;cursor:pointer;font-size:.68rem;font-weight:600;letter-spacing:.5px;
transition:transform .26s,background .26s;display:inline-flex;align-items:center;gap:8px;justify-content:center}
.srv-btn i{font-size:.9em;transform:translateY(1px)}
.srv-btn:hover{transform:translateY(-4px);background:var(--hover)}
.srv-btn:active{transform:translateY(-1px)}

/* ACHIEVEMENTS */
.achievements{display:flex;flex-direction:column;gap:26px}
.ach-lists{display:grid;gap:30px;grid-template-columns:repeat(auto-fit,minmax(350px,1fr))}
.ach-box{background:rgba(255,255,255,.07);border:1px solid rgba(255,255,255,.16);padding:20px 22px 22px;border-radius:22px;display:flex;flex-direction:column;gap:14px}
.ach-box h3{margin:0;font-size:.9rem;letter-spacing:.58px;text-transform:uppercase;color:#e5e5ea;cursor:default}
.ach-box h3[contenteditable="true"]{outline:2px solid rgba(255,255,255,.5)}
.ach-box li{font-size:.68rem;display:flex;align-items:flex-start;gap:8px;line-height:1.48;letter-spacing:.42px;color:#f0f0f4;cursor:default}
.ach-box li[contenteditable="true"]{outline:2px solid rgba(255,255,255,.45);border-radius:6px;padding:2px 4px}

/* MUSIC */
.music.card{padding:28px 32px 34px}
.music-simple{display:flex;flex-direction:column;gap:16px}
.music-controls-basic{display:flex;gap:12px;flex-wrap:wrap}
.music-controls-basic .btn{flex:1;min-width:90px}
#musicState{font-size:.65rem;color:#d0d0d6;letter-spacing:.5px;font-weight:600}

/* PANELS */
.panel-grid{display:flex;flex-direction:column;gap:30px}
.panels-horizontal{display:flex;flex-wrap:wrap;gap:20px}
.panels-horizontal .mini-panel{flex:1 1 clamp(240px,24%,300px);min-width:240px}
.mini-panel.card{padding:24px 26px 26px;position:relative}
.mini-panel.card.dragging{opacity:.35;outline:2px dashed rgba(255,255,255,.4)}
.panel-head{display:flex;justify-content:space-between;align-items:center;margin-bottom:14px}
.panel-head h3{margin:0;font-size:.78rem;letter-spacing:.6px;text-transform:uppercase;color:#e3e3ea;cursor:default}
.panel-head h3[contenteditable="true"]{outline:2px solid rgba(255,255,255,.5)}
.inline-edit{cursor:default;position:relative;padding:14px 14px;border:1px solid rgba(255,255,255,.18);border-radius:18px;background:rgba(255,255,255,.09);font-size:.72rem;min-height:54px;line-height:1.55;white-space:pre-wrap;text-align:center}
.inline-edit[contenteditable="true"]{cursor:text;outline:2px solid rgba(255,255,255,.55)}
.objectives-list{display:grid;gap:9px;font-size:.68rem}
.objectives-list li{display:flex;align-items:center;gap:10px;padding:8px 12px;border:1px solid rgba(255,255,255,.18);background:rgba(255,255,255,.085);border-radius:14px;cursor:pointer;transition:background .3s,border-color .3s}
.objectives-list li.done{opacity:.55;text-decoration:line-through}
.add-row{display:flex;gap:10px;margin-top:12px}
.add-row input{flex:1;padding:10px 12px;border-radius:12px;border:1px solid rgba(255,255,255,.25);background:rgba(255,255,255,.09);color:#fff;font-size:.65rem}
.obj-progress{margin-top:14px;display:flex;align-items:center;gap:10px;font-size:.6rem;letter-spacing:.5px}
.obj-progress .bar{flex:1;height:8px;background:#1a1c20;border-radius:6px;position:relative;overflow:hidden}
.obj-progress .bar span{position:absolute;inset:0;background:linear-gradient(90deg,#3ddc97,#2ca7ff);width:0;transition:width .45s}
.obj-progress .txt{min-width:90px;text-align:right;color:#d5d8de;font-weight:600}

/* CHANGELOG */
.changelog-list{display:flex;flex-direction:column;gap:10px;max-height:230px;overflow:auto;white-space:normal;word-break:break-word;overflow-wrap:anywhere;font-size:.62rem}
.changelog-list li{padding:9px 11px;border:1px solid rgba(255,255,255,.18);background:rgba(255,255,255,.1);border-radius:12px;display:flex;flex-direction:column;gap:4px;line-height:1.45}
.cl-date{font-size:.54rem;opacity:.7;letter-spacing:.55px}

/* PLACEHOLDER & FOOTER */
.placeholder-box{font-size:.65rem;opacity:.65;padding:16px 14px;border:1px dashed rgba(255,255,255,.3);border-radius:16px;text-align:center}
.last-update{font-size:.65rem;color:#d4d5da;letter-spacing:.5px;line-height:1.5;word-break:break-word}
.footer{text-align:center;font-size:.64rem;color:var(--muted);letter-spacing:.55px;padding-top:10px}

/* ADMIN / OWNER */
[data-admin]{display:none !important;}
.admin-mode [data-admin]{display:inline-flex !important;}
.admin-mode .add-row[data-admin]{display:flex !important;}
.owner-mode .srv-card,
.owner-mode .mini-panel,
.owner-mode .stat-chip,
.owner-mode [data-owner-block]{cursor:move}
.owner-mode [data-owner-editable]{transition:outline .25s}
.owner-mode [data-owner-editable]:hover{outline:1px dashed rgba(255,255,255,.35)}
.owner-mode [contenteditable="true"]{outline:2px solid rgba(255,255,255,.55)!important;border-radius:6px;padding:2px 4px}

/* MODES */
.clean-mode .servers,
.clean-mode .achievements,
.clean-mode .music,
.clean-mode .stats{display:none!important}
.streaming-mode .music,
.streaming-mode #debugPanel{display:none!important}
.streaming-mode .badge-mode{display:block !important;background:#0091ff;box-shadow:0 0 0 2px rgba(0,145,255,.5),0 0 16px -2px rgba(0,145,255,.85)}

/* BUTTONS */
.btn{
  --h:44px;height:var(--h);padding:0 18px;border-radius:16px;border:1px solid rgba(255,255,255,.22);background:var(--grad);
  color:#fff;cursor:pointer;display:inline-flex;align-items:center;justify-content:center;font-weight:600;font-size:.7rem;letter-spacing:.52px;
  position:relative;transition:transform .25s,background .25s;gap:8px}
.btn i{line-height:0;font-size:.9em;transform:translateY(1px)}
.btn:hover{transform:translateY(-4px);background:var(--hover)}
.btn:active{transform:translateY(-2px)}
.btn.small{--h:36px;padding:0 14px;font-size:.58rem;letter-spacing:.55px}
.btn.icon{width:44px;padding:0;justify-content:center;gap:0}
.btn.icon i{transform:none}
.btn.danger{background:linear-gradient(180deg,rgba(255,60,90,.42),rgba(255,60,90,.18));border-color:rgba(255,90,120,.45)}
.btn.danger:hover{background:linear-gradient(180deg,rgba(255,60,90,.55),rgba(255,60,90,.25))}
.btn.is-active{box-shadow:0 0 0 1px rgba(255,255,255,.28),0 0 10px -2px rgba(255,255,255,.6);background:var(--hover)}

.mode-toggle-bar{display:flex;gap:10px;align-items:center}
.mode-btn{--h:38px;height:var(--h);padding:0 14px;border-radius:14px;border:1px solid rgba(255,255,255,.25);
  background:linear-gradient(180deg,rgba(255,255,255,.14),rgba(255,255,255,.04));
  font-size:.62rem;letter-spacing:.6px;font-weight:600;cursor:pointer;color:#fff;display:inline-flex;align-items:center;gap:8px;
  transition:background .25s,box-shadow .25s,transform .25s}
.mode-btn i{line-height:0;font-size:.9em;transform:translateY(1px)}
.mode-btn:hover{transform:translateY(-3px);background:linear-gradient(180deg,rgba(255,255,255,.22),rgba(255,255,255,.09))}
.mode-btn.is-active{background:linear-gradient(180deg,rgba(120,200,255,.38),rgba(120,200,255,.15));
  box-shadow:0 0 0 1px rgba(120,200,255,.7),0 0 14px -2px rgba(120,200,255,.9);border-color:rgba(120,200,255,.7)}

/* MODAL */
#serverOverlay{position:fixed;inset:0;display:none;align-items:center;justify-content:center;z-index:220;background:rgba(0,0,0,.55);backdrop-filter:blur(8px)}
#serverOverlay.open{display:flex}
.server-modal-box{width:min(92vw,720px);max-height:88vh;overflow:auto;background:var(--card);border:1px solid var(--border);border-radius:30px;
padding:26px 28px 32px;position:relative;animation:mIn .35s ease}
@keyframes mIn{from{opacity:0;transform:translateY(30px)}to{opacity:1;transform:translateY(0)}}
.modal-close{position:absolute;top:14px;right:14px;width:46px;height:46px;border:1px solid rgba(255,255,255,.24);
background:var(--grad);border-radius:15px;color:#fff;cursor:pointer;display:grid;place-items:center}
.modal-head{display:flex;align-items:center;gap:22px;padding:10px 0 22px;border-bottom:1px solid rgba(255,255,255,.13)}
.modal-logo{width:66px;height:66px;border-radius:19px;background:linear-gradient(180deg,rgba(255,255,255,.2),rgba(255,255,255,.08));display:grid;place-items:center;font-weight:800;font-size:1rem;overflow:hidden;color:#fff}
.modal-content{padding:24px 4px 20px;display:flex;flex-direction:column;gap:16px}
.server-desc{font-size:.7rem;line-height:1.5;color:#d7d7dd;letter-spacing:.4px;white-space:pre-line}
.server-tags{display:flex;flex-wrap:wrap;gap:8px}
.server-tag{font-size:.58rem;padding:6px 8px;border:1px solid rgba(255,255,255,.24);background:rgba(255,255,255,.13);border-radius:8px;letter-spacing:.5px;font-weight:600}

/* SETTINGS PANEL */
#settingsPanel{position:fixed;top:0;right:-400px;width:380px;height:100vh;z-index:250;
  background:rgba(14,14,18,.95);backdrop-filter:blur(22px) saturate(170%);border-left:1px solid rgba(255,255,255,.18);
  display:flex;flex-direction:column;padding:26px 28px 36px;transition:right .55s cubic-bezier(.68,.05,.25,1)}
#settingsPanel.open{right:0}
#settingsPanel h3{margin:0 0 20px;font-size:1.05rem;font-weight:600;letter-spacing:.58px}
#settingsClose{position:absolute;top:14px;right:14px;width:46px;height:46px;border:1px solid rgba(255,255,255,.24);background:var(--grad);color:#fff;border-radius:15px;cursor:pointer;display:grid;place-items:center}
.setting-block{margin-bottom:22px}
.setting-block .title{font-size:.62rem;letter-spacing:.65px;text-transform:uppercase;font-weight:600;margin:0 0 12px;color:#dedee4}
.setting-row{display:flex;flex-wrap:wrap;gap:16px;font-size:.67rem;letter-spacing:.47px}
.setting-row label{display:flex;align-items:center;gap:6px;cursor:pointer}
.setting-block input[type=url]{width:100%;padding:10px 12px;background:rgba(255,255,255,.12);border:1px solid rgba(255,255,255,.26);
  border-radius:10px;color:#fff;font-size:.64rem}
#settingsSave{margin-top:6px;width:100%}

/* TOAST */
#toast{position:fixed;left:50%;bottom:36px;transform:translate(-50%,22px);background:rgba(0,0,0,.75);
padding:14px 22px;border-radius:16px;border:1px solid rgba(255,255,255,.24);
font-size:.62rem;letter-spacing:.55px;opacity:0;pointer-events:none;z-index:400;transition:opacity .45s,transform .45s}
#toast.show{opacity:1;transform:translate(-50%,0)}

/* DEBUG */
#debugPanel{position:fixed;top:78px;right:22px;width:320px;max-height:55vh;overflow:auto;
background:rgba(0,0,0,.82);border:1px solid rgba(255,255,255,.22);border-radius:18px;padding:14px 16px;
font-size:.6rem;line-height:1.4;display:none;z-index:140;backdrop-filter:blur(12px)}
#debugPanel.show{display:block}
#debugPanel pre{margin:8px 0 0;white-space:pre-wrap;word-break:break-word;font-family:ui-monospace,monospace;font-size:.58rem}

/* RIPPLE & CURSOR */
.ripple{position:absolute;border-radius:50%;transform:translate(-50%,-50%);background:rgba(255,255,255,.35);
width:10px;height:10px;pointer-events:none;animation:ripple .6s ease-out forwards}
@keyframes ripple{from{opacity:.6}to{width:240px;height:240px;opacity:0}}
.cursor-dot,.cursor-ring{display:none}
.cursor-ring.glow{box-shadow:0 0 14px rgba(255,255,255,.5),0 0 34px rgba(255,255,255,.25)}

@media (prefers-reduced-motion:reduce){
  .smoke,.aur,.entry-ring{animation:none!important}
  .srv-card,.s-card,.btn,.icon-btn{transition:none!important}
}
</style>
</head>
<body>
<div class="bg">
  <canvas id="bgParticles"></canvas>
  <div id="bgAurora"><div class="aur" id="a1"></div><div class="aur" id="a2"></div><div class="aur" id="a3"></div></div>
  <div id="bgCar"><div class="wash"></div><div class="smoke s1"></div><div class="smoke s2"></div><div class="smoke s3"></div><div class="car-img"></div><div class="vignette"></div></div>
  <div id="bgImage" class="bg-image"></div>
</div>

<div id="entry" class="entry">
  <div class="entry-box">
    <h1 class="entry-title" data-owner-editable>BestArcher_</h1>
    <p class="entry-sub">CLICK ANYWHERE TO ENTER</p>
    <div class="entry-ring"></div>
  </div>
</div>

<nav class="topbar" data-owner-block>
  <div class="brand" data-owner-editable><span>BestArcher_</span></div>
  <div style="display:flex;gap:10px;align-items:center">
    <button id="openSettings" class="btn small" type="button"><i class="fa-solid fa-gear"></i> Settings</button>
    <button id="toggleDebug" class="btn small" type="button" hidden><i class="fa-solid fa-bug"></i> Debug</button>
    <div class="mode-toggle-bar">
      <button id="toggleClean" class="mode-btn" type="button" title="Clean Mode"><i class="fa-solid fa-eye-slash"></i> Clean</button>
      <button id="toggleStream" class="mode-btn" type="button" title="Streaming Mode"><i class="fa-solid fa-tower-broadcast"></i> Stream</button>
      <button id="toggleLogoFit" class="mode-btn" type="button" title="Logos Cover"><i class="fa-solid fa-square"></i> Logos</button>
    </div>
  </div>
</nav>

<div class="badge-mode" id="modeBadge" style="display:none;position:fixed;top:70px;left:50%;transform:translateX(-50%);padding:6px 14px;border-radius:20px;font-size:.62rem;font-weight:600;letter-spacing:.6px;z-index:60;">STREAM MODE</div>

<main class="page" id="appRoot">

  <!-- 1 PERFIL -->
  <header class="hero card" id="heroSection" data-owner-block>
    <div class="avatar-wrap">
      <img class="avatar" src="assets/profile.jpg" alt="Perfil">
    </div>
    <div>
      <h1 class="name" data-owner-editable>BestArcher_ <span class="status-dot-inline"></span></h1>
      <p class="bio" data-owner-editable>Learning the best SS method · SS Verify Experience · SS Manager Experience · Staff on DynamicPvP</p>

      <div class="social-hub" id="socialHub">
        <div class="social-icons">
          <a class="icon-btn" href="https://namemc.com/profile/BestArcher_" target="_blank"><i class="fa-solid fa-user"></i></a>
            <!-- Email button (lo mantenemos, quitaste solo la tarjeta) -->
          <a class="icon-btn" href="https://www.instagram.com/tomas_attanzio/" target="_blank"><i class="fa-brands fa-instagram"></i></a>
          <a class="icon-btn" href="https://discord.com/users/1159617478725480580" target="_blank"><i class="fa-brands fa-discord"></i></a>
          <a class="icon-btn" href="https://github.com/BravveSS" target="_blank"><i class="fa-brands fa-github"></i></a>
          <a class="icon-btn" href="https://www.paypal.com/paypalme/my/profile" target="_blank"><i class="fa-brands fa-paypal"></i></a>
          <a class="icon-btn" href="https://www.tiktok.com/@tomasattanzio" target="_blank"><i class="fa-brands fa-tiktok"></i></a>
          <a class="icon-btn" href="https://www.youtube.com/@144_hz" target="_blank"><i class="fa-brands fa-youtube"></i></a>
          <button class="icon-btn" data-copy="tomasattanzioc@gmail.com" title="Copiar correo"><i class="fa-solid fa-envelope"></i></button>
        </div>

        <!-- Tarjetas: Quitada la de Email -->
        <div class="social-grid" id="socialGrid">
          <div class="s-card" data-copy="BestArcher_">
            <div class="s-thumb"><img src="assets/social/discord.png" alt="Discord"></div>
            <span data-owner-editable>Discord ID</span><small>Copiar</small>
          </div>
          <a class="s-card" href="https://github.com/BravveSS" target="_blank">
            <div class="s-thumb"><img src="assets/social/github.png" alt="GitHub"></div>
            <span data-owner-editable>GitHub</span><small>Perfil</small>
          </a>
          <a class="s-card" href="https://www.instagram.com/tomas_attanzio/" target="_blank">
            <div class="s-thumb"><img src="assets/social/instagram.png" alt="Instagram"></div>
            <span data-owner-editable>Instagram</span><small>Ver</small>
          </a>
          <a class="s-card" href="https://www.paypal.com/paypalme/my/profile" target="_blank">
            <div class="s-thumb"><img src="assets/social/paypal.png" alt="PayPal"></div>
            <span data-owner-editable>PayPal</span><small>Support</small>
          </a>
          <a class="s-card" href="https://namemc.com/profile/BestArcher_" target="_blank">
            <div class="s-thumb"><img src="assets/social/namemc.png" alt="NameMC"></div>
            <span data-owner-editable>NameMC</span><small>Skin</small>
          </a>
          <a class="s-card" href="https://www.tiktok.com/@tomasattanzio" target="_blank">
            <div class="s-thumb"><img src="assets/social/tiktok.png" alt="TikTok"></div>
            <span data-owner-editable>TikTok</span><small>Perfil</small>
          </a>
          <a class="s-card" href="https://www.youtube.com/@144_hz" target="_blank">
            <div class="s-thumb"><img src="assets/social/youtube.png" alt="YouTube"></div>
            <span data-owner-editable>YouTube</span><small>Channel</small>
          </a>
        </div>
      </div>
    </div>
  </header>

  <!-- 2 SERVIDORES -->
  <section class="servers card" id="serversSection" data-owner-block>
    <h2 class="section-title" data-owner-editable><i class="fa-solid fa-server"></i> Servidores</h2>
    <div class="grid" id="serversGrid">
      <article class="srv-card now-focus" data-name="DynoPvP" data-logo="assets/dynopvp.png">
        <div class="sheen"></div><div class="srv-inner">
          <div class="srv-top">
            <div class="srv-logo"><img src="assets/dynopvp.png" alt="DynoPvP"></div>
            <div class="srv-meta"><h3 data-owner-editable>DynoPvP</h3><span class="srv-year" data-owner-editable>2023</span></div>
          </div>
          <p class="srv-roles" data-owner-editable>SS Verify y Mod+</p>
          <button class="srv-btn" type="button"><i class="fa-solid fa-circle-info"></i> Ver más</button>
        </div>
      </article>
      <article class="srv-card" data-name="FladePvP" data-logo="assets/fladepvp.png">
        <div class="sheen"></div><div class="srv-inner">
          <div class="srv-top">
            <div class="srv-logo"><img src="assets/fladepvp.png" alt="FladePvP"></div>
            <div class="srv-meta"><h3 data-owner-editable>FladePvP</h3><span class="srv-year" data-owner-editable>2024</span></div>
          </div>
          <p class="srv-roles" data-owner-editable>SS Coordinator y Admin</p>
          <button class="srv-btn" type="button"><i class="fa-solid fa-circle-info"></i> Ver más</button>
        </div>
      </article>
      <article class="srv-card" data-name="InfernalMC" data-logo="assets/infernalmc.png">
        <div class="sheen"></div><div class="srv-inner">
          <div class="srv-top">
            <div class="srv-logo"><img src="assets/infernalmc.png" alt="InfernalMC"></div>
            <div class="srv-meta"><h3 data-owner-editable>InfernalMC</h3><span class="srv-year" data-owner-editable>2024</span></div>
          </div>
          <p class="srv-roles" data-owner-editable>SS Manager y Manager</p>
          <button class="srv-btn" type="button"><i class="fa-solid fa-circle-info"></i> Ver más</button>
        </div>
      </article>
      <article class="srv-card" data-name="AstralMC" data-logo="assets/astralmc.png">
        <div class="sheen"></div><div class="srv-inner">
          <div class="srv-top">
            <div class="srv-logo"><img src="assets/astralmc.png" alt="AstralMC"></div>
            <div class="srv-meta"><h3 data-owner-editable>AstralMC</h3><span class="srv-year" data-owner-editable>2025</span></div>
          </div>
          <p class="srv-roles" data-owner-editable>SS Trainer y Mod</p>
          <button class="srv-btn" type="button"><i class="fa-solid fa-circle-info"></i> Ver más</button>
        </div>
      </article>
      <article class="srv-card" data-name="DynamicPvP" data-logo="assets/dynamicpvp.png">
        <div class="sheen"></div><div class="srv-inner">
          <div class="srv-top">
            <div class="srv-logo"><img src="assets/dynamicpvp.png" alt="DynamicPvP"></div>
            <div class="srv-meta"><h3 data-owner-editable>DynamicPvP</h3><span class="srv-year" data-owner-editable>Now</span></div>
          </div>
          <p class="srv-roles" data-owner-editable>SS Verify y Mod</p>
          <button class="srv-btn" type="button"><i class="fa-solid fa-circle-info"></i> Ver más</button>
        </div>
      </article>
    </div>
  </section>

  <!-- (Mantengo STATS debajo de servidores? Tú pediste orden específico sin stats, pero no querías eliminar nada, así que la dejo después de servers y antes de logros, o la coloco al final. Para no romper nada la muevo debajo de servers invisible solo si quieres. Aquí la dejo detrás de servers por si la sigues usando) -->
  <section class="stats card" id="statsSection" data-owner-block style="order:2">
    <div class="stat-chip" data-owner-editable>All Servers <strong>+6</strong></div>
    <div class="stat-chip" data-owner-editable>SS Experience <strong>+2 Years</strong></div>
    <div class="stat-chip" data-owner-editable>SS Manager Experience <strong>1 Year</strong></div>
    <div class="stat-chip" data-owner-editable>Cases Reviewed <strong>120+</strong></div>
    <div class="stat-chip" id="viewsChip" data-owner-editable>Views <strong id="viewsValue">—</strong></div>
  </section>

  <!-- 3 LOGROS -->
  <section class="achievements card" id="achSection" data-owner-block>
    <h2 class="section-title" data-owner-editable><i class="fa-solid fa-trophy"></i> Logros</h2>
    <div class="ach-lists">
      <div class="ach-box">
        <h3 data-owner-editable>SS Category</h3>
        <ul>
          <li data-owner-editable><i class="fa-solid fa-book"></i> Creación de guías de SS avanzadas.</li>
          <li data-owner-editable><i class="fa-solid fa-people-group"></i> Organización y liderazgo de equipos SS.</li>
          <li data-owner-editable><i class="fa-solid fa-magnifying-glass"></i> Detección de cheats complejos y ofuscados.</li>
        </ul>
      </div>
      <div class="ach-box">
        <h3 data-owner-editable>Real Life Category</h3>
        <ul>
          <li data-owner-editable><i class="fa-solid fa-medal"></i> Campeón LigaMX Sub 15 2024.</li>
          <li data-owner-editable><i class="fa-regular fa-futbol"></i> Ex-Jugador Cruz Azul 2024.</li>
          <li data-owner-editable><i class="fa-regular fa-futbol"></i> Ex-Jugador Colegio Madrd 2025.</li>
          <li data-owner-editable><i class="fa-regular fa-futbol"></i> Jugador Barceloneta 2025.</li>
          <li data-owner-editable><i class="fa-solid fa-trophy"></i> Más de 8 títulos acumulados.</li>
        </ul>
      </div>
    </div>
  </section>

  <!-- 4 CURRENTLY DOING (extraído) -->
  <section class="card mini-panel" id="panelDoing" data-owner-block>
    <div class="panel-head">
      <h3 data-owner-editable>Currently Doing</h3>
      <div style="display:flex;gap:6px;flex-wrap:wrap">
        <button id="startSession" class="btn small" type="button" data-admin><i class="fa-solid fa-play"></i> Start SS</button>
        <button id="endSession" class="btn small danger" type="button" data-admin><i class="fa-solid fa-stop"></i> End SS</button>
        <button id="editDoing" class="btn small" type="button" data-admin><i class="fa-solid fa-pen"></i> Edit</button>
      </div>
    </div>
    <div id="doingContent" class="inline-edit" contenteditable="false">Disponible</div>
  </section>

  <!-- 5 MÚSICA -->
  <section class="music card" id="musicSection" data-owner-block>
    <h2 class="section-title" data-owner-editable><i class="fa-solid fa-music"></i> Música</h2>
    <div class="music-simple">
      <div id="musicState">Ready: cancion.mp3</div>
      <div class="music-controls-basic">
        <button id="playMusic" class="btn" type="button"><i class="fa-solid fa-play"></i> Play</button>
        <button id="volDown" class="btn" type="button" title="Vol -"><i class="fa-solid fa-volume-low"></i> -</button>
        <button id="volUp" class="btn" type="button" title="Vol +"><i class="fa-solid fa-volume-high"></i> +</button>
        <button id="muteMusic" class="btn" type="button" title="Mute"><i class="fa-solid fa-volume-xmark"></i> Mute</button>
        <button id="reloadAudio" class="btn" type="button" title="Recargar audio"><i class="fa-solid fa-rotate-right"></i> Reload</button>
      </div>
      <div class="volume-wrap" style="display:flex;align-items:center;gap:12px">
        <span style="font-size:.6rem;letter-spacing:.5px">VOL</span>
        <input id="volumeSlider" type="range" min="0" max="100" value="65">
      </div>
      <audio id="bgAudio" preload="auto" loop>
        <source src="assets/music/cancion.mp3" type="audio/mpeg">
        <source src="assets/music/cancion.ogg" type="audio/ogg">
      </audio>
    </div>
  </section>

  <!-- 6 VIEWS (extraído) -->
  <section class="card mini-panel" id="panelViews" data-owner-block>
    <div class="panel-head">
      <h3 data-owner-editable>Views</h3>
      <button id="refreshViews" class="btn small" type="button" data-admin title="Actualizar"><i class="fa-solid fa-rotate"></i></button>
    </div>
    <div style="font-size:.62rem;line-height:1.5;display:flex;flex-direction:column;gap:10px">
      <div style="font-size:1.2rem;font-weight:700;letter-spacing:.5px">
        <span id="viewsDisplayed">—</span>
      </div>
      <div data-admin id="viewsAdminControls" style="display:none;gap:6px;flex-wrap:wrap">
        <input id="viewSetInput" type="number" placeholder="Set" style="flex:1;min-width:90px;padding:6px 8px;border-radius:10px;border:1px solid rgba(255,255,255,.25);background:rgba(255,255,255,.1);color:#fff;font-size:.58rem">
        <button id="viewSetBtn" class="btn small" type="button" title="Aplicar"><i class="fa-solid fa-floppy-disk"></i></button>
        <button id="viewPlus1" class="btn small" type="button" title="+1">+1</button>
        <button id="viewPlus100" class="btn small" type="button" title="+100">+100</button>
        <button id="viewReset" class="btn small danger" type="button" title="Reset 0"><i class="fa-solid fa-ban"></i></button>
      </div>
    </div>
  </section>

  <!-- RESTO DE PANELES (no eliminados) -->
  <section class="panel-grid" id="extraPanels" data-owner-block>
    <div class="panels-horizontal" id="panelsRow" style="flex-wrap:wrap;gap:20px">
      <!-- Los que permanecen (ya no incluyen Doing ni Views) -->
      <div class="card mini-panel" id="panelObjectives">
        <div class="panel-head">
          <h3 data-owner-editable>Próximos Objetivos</h3>
          <button id="clearObjectives" class="btn small danger" type="button" title="Vaciar" data-admin><i class="fa-solid fa-trash"></i></button>
        </div>
        <ul id="objectivesList" class="objectives-list"></ul>
        <div class="add-row" data-admin>
          <input id="newObjective" type="text" placeholder="Nuevo objetivo...">
          <button id="addObjective" class="btn small" type="button"><i class="fa-solid fa-plus"></i></button>
        </div>
        <div class="obj-progress" id="objProgress" style="display:none">
          <div class="bar"><span id="objProgBar"></span></div>
          <div class="txt" id="objProgText">0%</div>
        </div>
      </div>

      <div class="card mini-panel" id="panelChangelog">
        <div class="panel-head">
          <h3 data-owner-editable>Changelog / Updates</h3>
          <button id="clearChangelog" class="btn small danger" type="button" title="Borrar todo" data-admin><i class="fa-solid fa-eraser"></i></button>
        </div>
        <ul id="changelogList" class="changelog-list"></ul>
        <div class="add-row" data-admin>
          <input id="newChange" type="text" placeholder="Nuevo cambio...">
          <button id="addChange" class="btn small" type="button"><i class="fa-solid fa-plus"></i></button>
        </div>
      </div>

      <div class="card mini-panel" id="panelLastUpdate">
        <div class="panel-head">
          <h3 data-owner-editable>Última Actualización</h3>
          <button id="manualUpdate" class="btn small" type="button" title="Forzar" data-admin><i class="fa-solid fa-clock-rotate-left"></i></button>
        </div>
        <div class="last-update" id="lastUpdateLabel">—</div>
        <div class="last-update" id="lastUpdateRelative" style="opacity:.75"></div>
      </div>

      <div class="card mini-panel" id="panelGallery" style="flex:1 1 300px">
        <div class="panel-head"><h3 data-owner-editable>Evidencias</h3></div>
        <div class="placeholder-box" data-owner-editable>PROXIMAMENTE...</div>
      </div>

      <div class="card mini-panel" id="panelTools" style="flex:1 1 300px">
        <div class="panel-head"><h3 data-owner-editable>Herramientas</h3></div>
        <div class="placeholder-box" data-owner-editable>PROXIMAMENTE...</div>
      </div>
    </div>
  </section>

  <!-- 7 COPYRIGHT -->
  <footer class="footer" id="footerSection" data-owner-block data-owner-editable>
    © <span id="year"></span> BestArcher_. All rights reserved.
  </footer>
</main>

<!-- MODAL SERVERS -->
<div id="serverOverlay" aria-hidden="true">
  <div class="server-modal-box" role="dialog" aria-modal="true">
    <button class="modal-close" id="closeServerModal" type="button" aria-label="Cerrar"><i class="fa-solid fa-xmark"></i></button>
    <div class="modal-head">
      <div class="modal-logo" id="mLogo">SV</div>
      <div>
        <h3 id="mTitle">Servidor</h3>
        <p id="mMeta" style="font-size:.66rem;letter-spacing:.4px;color:#cfd0d4">Año · Roles</p>
      </div>
    </div>
    <div class="modal-content">
      <div id="mDesc" class="server-desc">Sin datos.</div>
      <div id="mTags" class="server-tags"></div>
    </div>
    <div style="display:flex;justify-content:flex-end;gap:10px">
      <button class="btn small" type="button" id="closeServerBtn"><i class="fa-solid fa-check"></i> OK</button>
    </div>
  </div>
</div>

<!-- SETTINGS -->
<div id="settingsPanel" aria-hidden="true">
  <button id="settingsClose" aria-label="Cerrar"><i class="fa-solid fa-xmark"></i></button>
  <h3>Settings</h3>
  <div class="setting-block">
    <div class="title">Background</div>
    <div class="setting-row" id="bgModeRow">
      <label><input type="radio" name="bgmode" value="car"> Car</label>
      <label><input type="radio" name="bgmode" value="particles"> Particles</label>
      <label><input type="radio" name="bgmode" value="aurora"> Aurora</label>
      <label><input type="radio" name="bgmode" value="image"> Image</label>
    </div>
    <div id="bgImageField" style="margin-top:8px;display:none">
      <input id="bgImageUrl" type="url" placeholder="URL imagen...">
    </div>
    <div style="margin-top:10px" class="setting-row">
      <label><input id="dynamicBgToggle" type="checkbox"> Dynamic BG (Hour)</label>
    </div>
  </div>
  <div class="setting-block">
    <div class="title">Interacción</div>
    <div class="setting-row">
      <label><input id="tiltToggle" type="checkbox"> Tilt</label>
      <label>Cursor
        <select id="cursorStyle" style="background:#121317;color:#fff;border:1px solid rgba(255,255,255,.25);border-radius:8px;padding:4px 6px;font-size:.65rem">
          <option value="minimal">Minimal</option>
          <option value="glow">Glow</option>
          <option value="off">Off</option>
        </select>
      </label>
      <label><input id="cleanToggle" type="checkbox"> Clean Mode</label>
      <label><input id="streamToggle" type="checkbox"> Streaming Mode</label>
      <label><input id="logoFitToggleChk" type="checkbox"> Logos Cover</label>
    </div>
  </div>
  <div class="setting-block">
    <div class="title">Audio</div>
    <div class="setting-row">
      <label><input id="autoplayToggle" type="checkbox"> Autoplay</label>
      <label>Vol <input id="initVol" type="range" min="0" max="100" value="65"></label>
    </div>
  </div>
  <button id="settingsSave" class="btn small">Guardar</button>
</div>

<div id="debugPanel"><strong>DEBUG</strong><pre id="debugLog"></pre></div>
<div id="toast" role="status"></div>

<script>
/* =============== CONFIG PASSWORDS =============== */
const ADMIN_HASH = "8d1a714fdc290c65b183a88f7d3b474634579ac6b73b8cdaf704490049591484"; // hash admin
const OWNER_PASSWORD = "BestOwner2025"; // contraseña owner (texto plano)

/* =============== FLAGS =============== */
let isAdmin=false,isOwner=false,globalEdit=false;

/* =============== HELPERS =============== */
const $=(s,c=document)=>c.querySelector(s);
const $$=(s,c=document)=>Array.from(c.querySelectorAll(s));
const toast=(m,d=1800)=>{const t=$("#toast");t.textContent=m;t.classList.add('show');clearTimeout(t._t);t._t=setTimeout(()=>t.classList.remove('show'),d);};
const log=(m)=>{ if(!window._debug)return; const l=$("#debugLog"); l.textContent+=m+"\\n"; l.scrollTop=l.scrollHeight; };
async function sha256Hex(str){
  const enc=new TextEncoder();const buf=await crypto.subtle.digest('SHA-256',enc.encode(str));
  return Array.from(new Uint8Array(buf)).map(b=>b.toString(16).padStart(2,'0')).join('');
}
function sanitizeText(t){return t.replace(/[<>]/g,'').replace(/\\s+$/,'');}
function ripple(e,btn){
  const r=document.createElement('span');r.className='ripple';
  const rect=btn.getBoundingClientRect();
  r.style.left=(e.clientX-rect.left)+'px';r.style.top=(e.clientY-rect.top)+'px';
  btn.appendChild(r);r.addEventListener('animationend',()=>r.remove());
}

/* =============== ADMIN MODE =============== */
async function requestAdmin(){
  const pwd=prompt("Password Admin:"); if(!pwd)return;
  const h=await sha256Hex(pwd);
  if(h===ADMIN_HASH){
    isAdmin=true;document.documentElement.classList.add('admin-mode');toast("Admin ON");
    refreshObjectivesEditButtons();showViewAdmin();
  } else toast("Incorrecta");
}
function revokeAdmin(){
  isAdmin=false;document.documentElement.classList.remove('admin-mode');
  toast("Admin OFF");refreshObjectivesEditButtons();hideViewAdmin();
}

/* =============== OWNER MODE =============== */
function requestOwner(){
  const pwd=prompt("Owner password:"); if(pwd===OWNER_PASSWORD){
    isOwner=true;document.documentElement.classList.add('owner-mode');toast("Owner ON");
    enableOwnerEditable(globalEdit);enableDragAll();
    restoreOrders();restoreOwnerTexts();
  }else if(pwd) toast("Clave incorrecta");
}
function revokeOwner(){
  isOwner=false;document.documentElement.classList.remove('owner-mode');
  toast("Owner OFF");disableDragAll();enableOwnerEditable(false);
}
function toggleGlobalEdit(){
  if(!isOwner){toast("Solo owner");return;}
  globalEdit=!globalEdit;
  enableOwnerEditable(globalEdit);
  toast(globalEdit?"Edición Global ON":"Edición Global OFF");
}

/* =============== OWNER TEXT STORAGE =============== */
const OWNER_TEXT_KEY='ba_owner_text_map_v2';
function enableOwnerEditable(on){
  $$('[data-owner-editable]').forEach(el=>{
    if(on){
      el.setAttribute('contenteditable','true');
      if(!el._ownerListener){
        el._ownerListener=true;
        el.addEventListener('blur',ownerSaveText);
      }
    }else{
      el.removeAttribute('contenteditable');
    }
  });
}
function ownerSaveText(e){
  const map=JSON.parse(localStorage.getItem(OWNER_TEXT_KEY)||'{}');
  const uid=getOwnerUID(e.target);
  map[uid]=sanitizeText(e.target.innerText.trim());
  localStorage.setItem(OWNER_TEXT_KEY,JSON.stringify(map));
}
function getOwnerUID(el){
  if(!el.dataset.oid) el.dataset.oid='oid_'+Math.random().toString(36).slice(2,10);
  return el.dataset.oid;
}
function restoreOwnerTexts(){
  const map=JSON.parse(localStorage.getItem(OWNER_TEXT_KEY)||'{}');
  Object.entries(map).forEach(([oid,txt])=>{
    const el=$('[data-owner-editable][data-oid="'+oid+'"]');
    if(el) el.innerText=txt;
  });
}

/* =============== DRAG & DROP (Owner) =============== */
const ORDER_SERVERS_KEY='ba_order_servers';
const ORDER_PANELS_KEY='ba_order_panels';
const ORDER_STATS_KEY='ba_order_stats';
const ORDER_SECTIONS_KEY='ba_order_sections';
let dragSrcEl=null;

function enableDragAll(){
  $$('#serversGrid .srv-card').forEach(card=>prepDraggable(card,'server'));
  $$('#extraPanels .mini-panel, #panelDoing, #panelViews').forEach(p=>prepDraggable(p,'panel'));
  $$('#statsSection .stat-chip').forEach(ch=>prepDraggable(ch,'stat'));
  // top-level sections
  $('#appRoot').childNodes.forEach(node=>{
    if(node.nodeType===1 && node.matches('[data-owner-block], .card')){
      node.setAttribute('data-owner-block','');
      prepDraggable(node,'section');
    }
  });
}
function disableDragAll(){
  document.querySelectorAll('.dragging').forEach(e=>e.classList.remove('dragging'));
  const all=[...document.querySelectorAll('[draggable]')];
  all.forEach(el=>{
    el.removeAttribute('draggable');
    el.removeEventListener('dragstart',dragStart);
    el.removeEventListener('dragover',dragOver);
    el.removeEventListener('drop',dropItem);
    el.removeEventListener('dragend',dragEnd);
  });
}
function prepDraggable(el,type){
  el.draggable=true;
  el.dataset.dragType=type;
  el.addEventListener('dragstart',dragStart);
  el.addEventListener('dragover',dragOver);
  el.addEventListener('drop',dropItem);
  el.addEventListener('dragend',dragEnd);
}
function dragStart(e){
  dragSrcEl=this;
  this.classList.add('dragging');
  e.dataTransfer.effectAllowed='move';
  e.dataTransfer.setData('text/plain',this.dataset.dragType||'');
}
function dragOver(e){
  if(!dragSrcEl)return;
  if(this===dragSrcEl)return;
  if(this.dataset.dragType!==dragSrcEl.dataset.dragType)return;
  e.preventDefault();
  const parent=this.parentElement;
  const nodes=[...parent.children];
  const dragIndex=nodes.indexOf(dragSrcEl);
  const targetIndex=nodes.indexOf(this);
  if(dragIndex<targetIndex) parent.insertBefore(dragSrcEl,this.nextSibling);
  else parent.insertBefore(dragSrcEl,this);
}
function dropItem(e){e.stopPropagation();}
function dragEnd(){
  this.classList.remove('dragging');
  saveOrders();
}
function saveOrders(){
  const srvOrder=$$('#serversGrid .srv-card').map(c=>c.dataset.name||c.querySelector('h3')?.textContent?.trim());
  localStorage.setItem(ORDER_SERVERS_KEY,JSON.stringify(srvOrder));
  const pnlOrder=[...document.querySelectorAll('#panelDoing,#panelViews,#extraPanels .mini-panel')].map(p=>p.id);
  localStorage.setItem(ORDER_PANELS_KEY,JSON.stringify(pnlOrder));
  $$('#statsSection .stat-chip').forEach(ch=>{if(!ch.dataset.oid) ch.dataset.oid='stat_'+Math.random().toString(36).slice(2,8);});
  const statsOrder=$$('#statsSection .stat-chip').map(ch=>ch.dataset.oid);
  localStorage.setItem(ORDER_STATS_KEY,JSON.stringify(statsOrder));
  const secOrder=[...$('#appRoot').children].map(sec=>sec.id||sec.className||'node');
  localStorage.setItem(ORDER_SECTIONS_KEY,JSON.stringify(secOrder));
}
function restoreOrders(){
  // servers
  const srvOrder=JSON.parse(localStorage.getItem(ORDER_SERVERS_KEY)||'[]');
  if(srvOrder.length){
    const grid=$("#serversGrid");
    srvOrder.forEach(name=>{
      const card=[...grid.children].find(c=>(c.dataset.name||c.querySelector('h3')?.textContent.trim())===name);
      if(card) grid.appendChild(card);
    });
  }
  // panels
  const pnlOrder=JSON.parse(localStorage.getItem(ORDER_PANELS_KEY)||'[]');
  if(pnlOrder.length){
    pnlOrder.forEach(id=>{
      const el=document.getElementById(id);
      if(!el) return;
      if(id==='panelDoing'){
        // keep order where it is (already placed)
        $('#panelDoing') && $('#panelDoing').parentElement.appendChild(el);
      }else if(id==='panelViews'){
        $('#panelViews') && $('#panelViews').parentElement.appendChild(el);
      }else{
        const container=$("#extraPanels .panels-horizontal")||$("#extraPanels");
        container && container.appendChild(el);
      }
    });
  }
  // stats
  const statsOrder=JSON.parse(localStorage.getItem(ORDER_STATS_KEY)||'[]');
  if(statsOrder.length){
    const statSection=$("#statsSection");
    statsOrder.forEach(oid=>{
      const chip=[...statSection.querySelectorAll('.stat-chip')].find(ch=>ch.dataset.oid===oid);
      if(chip) statSection.appendChild(chip);
    });
  }
  // sections
  const secOrder=JSON.parse(localStorage.getItem(ORDER_SECTIONS_KEY)||'[]');
  if(secOrder.length){
    const root=$("#appRoot");
    secOrder.forEach(id=>{
      const el=$('#'+CSS.escape(id));
      if(el && el.parentElement===root) root.appendChild(el);
    });
  }
}

/* EMOJI SPACING */
function fixEmojiSpacingText(str){
  return str.replace(/([\p{Extended_Pictographic}])(?=[^\s\p{Extended_Pictographic}])/gu,'$1 ').replace(/ {2,}/g,' ');
}
function fixEmojiSpacing(root=document.body){
  const walker=document.createTreeWalker(root,NodeFilter.SHOW_TEXT,null);
  const nodes=[];while(walker.nextNode()) nodes.push(walker.currentNode);
  nodes.forEach(n=>{
    if(n.parentElement && ['INPUT','TEXTAREA'].includes(n.parentElement.tagName)) return;
    const t=n.textContent;const f=fixEmojiSpacingText(t);if(f!==t) n.textContent=f;
  });
}

/* SETTINGS */
const STORAGE_KEY='ba_final_custom_settings_v10';
const defaults={bgMode:'car',bgImageUrl:'',tilt:true,cursor:'minimal',musicAutoplay:true,musicInitVol:0.65,dynamicBG:false,cleanMode:false,streamMode:false,logoCover:true};
let settings;try{settings={...defaults,...JSON.parse(localStorage.getItem(STORAGE_KEY)||'{}')}}catch{settings={...defaults}}
const saveSettings=()=>localStorage.setItem(STORAGE_KEY,JSON.stringify(settings));

/* DATA KEYS */
const K_DOING='ba_doing_text',K_OBJECTIVES='ba_objectives_list',K_CHANGELOG='ba_changelog_list',K_LASTUPDATE='ba_last_update',K_SS_SESSION_START='ba_ss_session_start';

/* VIEWS */
const K_VIEWS_REAL='ba_views_real',K_VIEWS_ADJ='ba_views_adj',K_VIEWS_LAST_HIT='ba_views_last_hit';
const VIEW_NAMESPACE='bestarcher_portfolio',VIEW_KEY='global_views_v2',VIEW_API='https://api.countapi.xyz';
const VISIT_COOLDOWN_MS=6*60*60*1000;
let viewsReal=Number(localStorage.getItem(K_VIEWS_REAL)||0);
let viewsAdj=Number(localStorage.getItem(K_VIEWS_ADJ)||0);
function showViewAdmin(){ $("#viewsAdminControls")?.setAttribute('style','display:flex;gap:6px;flex-wrap:wrap'); }
function hideViewAdmin(){ $("#viewsAdminControls")?.setAttribute('style','display:none'); }
function updateViewsUI(){const total=viewsReal+viewsAdj;$("#viewsDisplayed").textContent=total;$("#viewsValue").textContent=total;}
async function fetchView(hit){
  const url=hit?`${VIEW_API}/hit/${VIEW_NAMESPACE}/${VIEW_KEY}`:`${VIEW_API}/get/${VIEW_NAMESPACE}/${VIEW_KEY}`;
  try{const r=await fetch(url);if(!r.ok)throw 0;const d=await r.json();return d.value;}catch{return null;}
}
async function initViews(){
  const now=Date.now();const last=Number(localStorage.getItem(K_VIEWS_LAST_HIT)||0);
  const doHit=(now-last)>VISIT_COOLDOWN_MS;
  const val=await fetchView(doHit);
  if(val!==null){viewsReal=val;localStorage.setItem(K_VIEWS_REAL,String(val));if(doHit)localStorage.setItem(K_VIEWS_LAST_HIT,String(now));}
  updateViewsUI();
}
$("#refreshViews")?.addEventListener('click',async()=>{
  if(!isAdmin){toast('Solo admin');return;}
  const val=await fetchView(false);
  if(val!==null){viewsReal=val;localStorage.setItem(K_VIEWS_REAL,String(val));updateViewsUI();toast('Actualizado');}
  else toast('Error');
});
$("#viewSetBtn")?.addEventListener('click',()=>{
  if(!isAdmin){toast('Solo admin');return;}
  const t=Number($("#viewSetInput").value||0);if(isNaN(t))return;
  viewsAdj=t-viewsReal;localStorage.setItem(K_VIEWS_ADJ,String(viewsAdj));updateViewsUI();toast('Set');
});
$("#viewPlus1")?.addEventListener('click',()=>{if(!isAdmin)return;viewsAdj++;localStorage.setItem(K_VIEWS_ADJ,String(viewsAdj));updateViewsUI();});
$("#viewPlus100")?.addEventListener('click',()=>{if(!isAdmin)return;viewsAdj+=100;localStorage.setItem(K_VIEWS_ADJ,String(viewsAdj));updateViewsUI();});
$("#viewReset")?.addEventListener('click',()=>{if(!isAdmin)return;if(!confirm('¿Reset a 0?'))return;viewsAdj=-viewsReal;localStorage.setItem(K_VIEWS_ADJ,String(viewsAdj));updateViewsUI();toast('Reset');});

/* BACKGROUND / CURSOR / TILT */
const bgParticles=$("#bgParticles"), bgAurora=$("#bgAurora"), bgCar=$("#bgCar"), bgImg=$("#bgImage");
let pCtx,pArr=[],pRAF,backgroundApplied=false;
function hideAllBg(){[bgParticles,bgAurora,bgCar,bgImg].forEach(e=>e.style.display='none');cancelAnimationFrame(pRAF);}
function startParticles(){
  bgParticles.style.display='block';pCtx=bgParticles.getContext('2d');
  function resize(){bgParticles.width=innerWidth;bgParticles.height=innerHeight;const count=Math.floor((innerWidth*innerHeight)/26000);
    pArr=Array.from({length:count},()=>({x:Math.random()*innerWidth,y:Math.random()*innerHeight,vx:(Math.random()-.5)*0.28,vy:(Math.random()-.5)*0.28}));}
  resize();addEventListener('resize',resize);
  (function frame(){pCtx.clearRect(0,0,innerWidth,innerHeight);
    pArr.forEach(p=>{p.x+=p.vx;p.y+=p.vy;if(p.x<0)p.x+=innerWidth;else if(p.x>innerWidth)p.x-=innerWidth;if(p.y<0)p.y+=innerHeight;else if(p.y>innerHeight)p.y-=innerHeight;
      pCtx.fillStyle='rgba(215,225,255,.38)';pCtx.fillRect(p.x,p.y,2.2,2.2);});
    pRAF=requestAnimationFrame(frame);})();
}
function hourBackground(){const h=new Date().getHours();if(h>=6&&h<12)return'particles';if(h>=12&&h<18)return'aurora';if(h>=18&&h<=23)return'car';return'car';}
function applyBackground(force=false){
  if(!force && backgroundApplied && !settings.dynamicBG)return;
  hideAllBg();let mode=settings.bgMode;if(settings.dynamicBG)mode=hourBackground();
  if(mode==='car') bgCar.style.display='block';
  else if(mode==='particles') startParticles();
  else if(mode==='aurora') bgAurora.style.display='block';
  else if(mode==='image'){bgImg.style.display='block';bgImg.style.backgroundImage=settings.bgImageUrl?`url("${settings.bgImageUrl}")`:'none';}
  backgroundApplied=true;
}
const cursorDot=document.createElement('div'), cursorRing=document.createElement('div');
cursorDot.className='cursor-dot';cursorRing.className='cursor-ring';
function injectCursor(){document.body.appendChild(cursorDot);document.body.appendChild(cursorRing);}
function applyCursor(style){
  if(style==='off'||!matchMedia('(pointer:fine)').matches){cursorDot.style.display='none';cursorRing.style.display='none';return;}
  cursorDot.style.cssText='position:fixed;top:0;left:0;width:6px;height:6px;background:#fff;border-radius:50%;pointer-events:none;z-index:1000;display:block;transform:translate(-50%,-50%)';
  cursorRing.style.cssText='position:fixed;top:0;left:0;width:38px;height:38px;border:2px solid rgba(255,255,255,.35);border-radius:50%;pointer-events:none;z-index:1000;display:block;transform:translate(-50%,-50%);transition:width .25s,height .25s,border-color .25s';
  cursorRing.classList.toggle('glow',style==='glow');
  if(!cursorDot.dataset.started){
    cursorDot.dataset.started='1';let mx=innerWidth/2,my=innerHeight/2,rx=mx,ry=my;
    (function loop(){rx+=(mx-rx)*0.18;ry+=(my-ry)*0.18;cursorDot.style.transform=`translate(${mx}px,${my}px)`;cursorRing.style.transform=`translate(${rx}px,${ry}px)`;requestAnimationFrame(loop);})();
    addEventListener('mousemove',e=>{mx=e.clientX;my=e.clientY;},{passive:true});
    addEventListener('mousedown',()=>{cursorRing.style.width='56px';cursorRing.style.height='56px';});
    addEventListener('mouseup',()=>{cursorRing.style.width='38px';cursorRing.style.height='38px';});
  }
}
function applyTilt(on){
  $$('.srv-card').forEach(el=>{
    el.onmousemove=null;el.onmouseleave=null;el.style.transform='';
    if(!on||!matchMedia('(pointer:fine)').matches||document.body.classList.contains('streaming-mode'))return;
    let af=null,tx=0,ty=0,cx=0,cy=0;
    function anim(){af=null;cx+=(tx-cx)*0.18;cy+=(ty-cy)*0.18;el.style.transform=`perspective(900px) rotateX(${cx}deg) rotateY(${cy}deg)`;if(Math.abs(cx-tx)>0.05||Math.abs(cy-ty)>0.05)af=requestAnimationFrame(anim);}
    el.addEventListener('mousemove',e=>{
      const r=el.getBoundingClientRect(),x=(e.clientX-r.left)/r.width,y=(e.clientY-r.top)/r.height;
      tx=(0.5-y)*9;ty=(x-0.5)*9;if(!af)af=requestAnimationFrame(anim);
    });
    el.addEventListener('mouseleave',()=>{tx=ty=0;if(!af)af=requestAnimationFrame(anim);});
  });
}

/* SERVER MODAL */
const serverDetails={
  DynoPvP:{desc:"Moderación y SS enfocada en jugadores competitivos.",tags:["SS","Mod","Verify"]},
  FladePvP:{desc:"Coordinación y administración de procesos SS internos.",tags:["Admin","Coord"]},
  InfernalMC:{desc:"Gestión de equipo y optimización de revisiones.",tags:["Manager","Lead"]},
  AstralMC:{desc:"Entrenamiento de nuevos verificadores.",tags:["Trainer","Mod"]},
  DynamicPvP:{desc:"Verificaciones activas y soporte rápido.",tags:["Verify","Support"]}
};
const overlay=$("#serverOverlay");const mTitle=$("#mTitle"),mMeta=$("#mMeta"),mLogo=$("#mLogo"),mDesc=$("#mDesc"),mTags=$("#mTags");
function openServer(card){
  const name=card.querySelector('h3')?.textContent.trim()||card.dataset.name||'Servidor';
  const year=card.querySelector('.srv-year')?.textContent.trim()||'—';
  const roles=card.querySelector('.srv-roles')?.textContent.trim()||'—';
  const info=serverDetails[name]||{desc:"Sin datos.",tags:["—"]};
  mTitle.textContent=name;mMeta.textContent=`${year} · ${roles}`;
  mLogo.textContent=(name||'SV').slice(0,2);
  mLogo.style.backgroundImage=card.dataset.logo?`url("${card.dataset.logo}")`:'none';
  mLogo.style.backgroundSize='cover';mLogo.style.backgroundPosition='center';
  mDesc.textContent=info.desc;
  mTags.innerHTML=info.tags.map(t=>`<span class="server-tag">${t}</span>`).join('');
  overlay.classList.add('open');document.body.classList.add('modal-open');
}
function closeServerModal(){overlay.classList.remove('open');document.body.classList.remove('modal-open');}
overlay.addEventListener('click',e=>{if(e.target===overlay)closeServerModal();});
$("#closeServerModal").addEventListener('click',closeServerModal);
$("#closeServerBtn").addEventListener('click',closeServerModal);
$$('.srv-card').forEach(c=>{
  c.querySelector('.srv-btn').addEventListener('click',e=>{e.stopPropagation();openServer(c);});
  c.addEventListener('click',e=>{if(e.target.closest('.srv-btn'))return;openServer(c);});
});

/* MUSIC */
const audioEl=$("#bgAudio");
const playBtn=$("#playMusic"), volDown=$("#volDown"), volUp=$("#volUp"), muteBtn=$("#muteMusic"),
      volSlider=$("#volumeSlider"), musicState=$("#musicState"), reloadBtn=$("#reloadAudio");
function updateMusicState(){
  const src=(audioEl.currentSrc.split('/').pop()||'cancion.mp3');
  musicState.textContent=(audioEl.paused?'Pausado: ':'Reproduciendo: ')+src+(audioEl.muted?' (Muted)':'');
}
audioEl.addEventListener('error',()=>toast('Error audio'));
playBtn.addEventListener('click',()=>{
  if(audioEl.paused){
    audioEl.play().then(()=>{playBtn.innerHTML='<i class="fa-solid fa-pause"></i> Pause';updateMusicState();})
      .catch(()=>toast('Reproducción bloqueada'));
  }else{audioEl.pause();playBtn.innerHTML='<i class="fa-solid fa-play"></i> Play';updateMusicState();}
});
reloadBtn.addEventListener('click',()=>{audioEl.pause();audioEl.currentTime=0;audioEl.load();toast('Audio recargado');updateMusicState();});
volDown.addEventListener('click',()=>{audioEl.volume=Math.max(0,audioEl.volume-0.1);volSlider.value=Math.round(audioEl.volume*100);updateMusicState();});
volUp.addEventListener('click',()=>{audioEl.volume=Math.min(1,audioEl.volume+0.1);volSlider.value=Math.round(audioEl.volume*100);updateMusicState();});
muteBtn.addEventListener('click',()=>{audioEl.muted=!audioEl.muted;muteBtn.innerHTML=audioEl.muted?'<i class="fa-solid fa-volume-xmark"></i> Mute':'<i class="fa-solid fa-volume-high"></i> Mute';updateMusicState();});
volSlider.addEventListener('input',()=>{audioEl.volume=(volSlider.value|0)/100;audioEl.muted=audioEl.volume===0;muteBtn.innerHTML=audioEl.muted?'<i class="fa-solid fa-volume-xmark"></i> Mute':'<i class="fa-solid fa-volume-high"></i> Mute';updateMusicState();});

/* CURRENTLY DOING */
const doingEl=$("#doingContent"), editDoing=$("#editDoing");
function loadDoing(){doingEl.textContent=fixEmojiSpacingText(localStorage.getItem(K_DOING)||'Disponible');}
function saveDoing(){
  let txt=fixEmojiSpacingText(doingEl.textContent.trim()||'Disponible');doingEl.textContent=txt;
  localStorage.setItem(K_DOING,txt);doingEl.dataset.base=txt;updateLastUpdate();
}
editDoing.addEventListener('click',()=>{
  if(!isAdmin){toast('Solo admin');return;}
  const editing=doingEl.getAttribute('contenteditable')==='true';
  if(!editing){doingEl.setAttribute('contenteditable','true');doingEl.focus();editDoing.innerHTML='<i class="fa-solid fa-floppy-disk"></i> Save';}
  else{doingEl.setAttribute('contenteditable','false');saveDoing();editDoing.innerHTML='<i class="fa-solid fa-pen"></i> Edit';}
});

/* SS SESSION TIMER */
const startSessionBtn=$("#startSession"), endSessionBtn=$("#endSession");
let sessionStart=null;
function loadSession(){const s=localStorage.getItem(K_SS_SESSION_START);if(s)sessionStart=+s;}
function startSession(){
  if(!isAdmin){toast('Solo admin');return;}
  if(sessionStart){toast('Ya activa');return;}
  sessionStart=Date.now();localStorage.setItem(K_SS_SESSION_START,String(sessionStart));
  doingEl.dataset.base=doingEl.textContent;toast('SS Session iniciada');
}
function endSession(){
  if(!isAdmin){toast('Solo admin');return;}
  if(!sessionStart){toast('No hay sesión');return;}
  const mins=Math.floor((Date.now()-sessionStart)/60000);
  addChangelogEntry(`Sesión SS finalizada (${mins} min)`);
  localStorage.removeItem(K_SS_SESSION_START);sessionStart=null;delete doingEl.dataset.base;saveDoing();toast('SS Session terminada');updateLastUpdate();
}
startSessionBtn.addEventListener('click',startSession);
endSessionBtn.addEventListener('click',endSession);
function renderSessionTicker(){
  if(sessionStart&&doingEl.dataset.base){
    const diff=Date.now()-sessionStart;const m=Math.floor(diff/60000);const s=Math.floor((diff/1000)%60);
    doingEl.textContent=doingEl.dataset.base+' · SS '+String(m).padStart(2,'0')+':'+String(s).padStart(2,'0');
  }
  requestAnimationFrame(renderSessionTicker);
}

/* OBJECTIVES */
const objList=$("#objectivesList"), objInput=$("#newObjective"), objAdd=$("#addObjective"), objClear=$("#clearObjectives");
const objProgressWrap=$("#objProgress"), objProgBar=$("#objProgBar"), objProgText=$("#objProgText");
function loadObjectives(){
  objList.innerHTML='';const arr=JSON.parse(localStorage.getItem(K_OBJECTIVES)||'[]');
  arr.forEach(o=>renderObjective(o));updateObjectivesProgress();fixEmojiSpacing(objList);
}
function saveObjectives(){
  const data=[...objList.children].map(li=>({text:li.dataset.text,done:li.classList.contains('done')}));
  localStorage.setItem(K_OBJECTIVES,JSON.stringify(data));updateObjectivesProgress();
}
function renderObjective(o){
  const li=document.createElement('li');const txt=fixEmojiSpacingText(o.text);li.dataset.text=txt;
  if(o.done) li.classList.add('done');
  li.innerHTML=`<span>${txt}</span>${isAdmin?'<button class="btn small icon danger" type="button" title="Eliminar"><i class="fa-solid fa-xmark"></i></button>':''}`;
  li.addEventListener('click',e=>{
    if(!isAdmin)return;
    if(e.target.closest('button'))return;
    li.classList.toggle('done');saveObjectives();updateLastUpdate();
  });
  if(isAdmin) li.querySelector('button')?.addEventListener('click',()=>{li.remove();saveObjectives();updateLastUpdate();});
  objList.appendChild(li);
}
function refreshObjectivesEditButtons(){loadObjectives();}
objAdd?.addEventListener('click',()=>{
  if(!isAdmin){toast('Solo admin');return;}
  let v=objInput.value.trim();if(!v)return;
  v=fixEmojiSpacingText(v);renderObjective({text:v,done:false});saveObjectives();objInput.value='';updateLastUpdate();
});
objInput?.addEventListener('keydown',e=>{if(e.key==='Enter')objAdd.click();});
objClear?.addEventListener('click',()=>{
  if(!isAdmin){toast('Solo admin');return;}
  if(!confirm('¿Vaciar objetivos?'))return;
  localStorage.removeItem(K_OBJECTIVES);loadObjectives();updateLastUpdate();
});
function updateObjectivesProgress(){
  const arr=JSON.parse(localStorage.getItem(K_OBJECTIVES)||'[]');
  if(!arr.length){objProgressWrap.style.display='none';return;}
  objProgressWrap.style.display='flex';
  const done=arr.filter(o=>o.done).length,pct=Math.round(done/arr.length*100);
  objProgBar.style.width=pct+'%';objProgText.textContent=pct+'% ('+done+'/'+arr.length+')';
}

/* CHANGELOG */
const clList=$("#changelogList"), clInput=$("#newChange"), clAdd=$("#addChange"), clClear=$("#clearChangelog");
function loadChangelog(){
  clList.innerHTML='';const arr=JSON.parse(localStorage.getItem(K_CHANGELOG)||'[]').sort((a,b)=>b.time-a.time);
  arr.forEach(it=>renderChange(it));fixEmojiSpacing(clList);
}
function saveChangelog(arr){localStorage.setItem(K_CHANGELOG,JSON.stringify(arr));}
function addChangelogEntry(text){
  text=fixEmojiSpacingText(text);const arr=JSON.parse(localStorage.getItem(K_CHANGELOG)||'[]');
  arr.push({text,time:Date.now()});saveChangelog(arr);loadChangelog();
}
function renderChange(it){
  const li=document.createElement('li');
  li.innerHTML=`<span>${it.text}</span><span class="cl-date">${new Date(it.time).toLocaleString()}</span>`;
  clList.appendChild(li);
}
clAdd?.addEventListener('click',()=>{
  if(!isAdmin){toast('Solo admin');return;}
  let v=clInput.value.trim();if(!v)return;
  addChangelogEntry(v);clInput.value='';updateLastUpdate();
});
clInput?.addEventListener('keydown',e=>{if(e.key==='Enter')clAdd.click();});
clClear?.addEventListener('click',()=>{
  if(!isAdmin){toast('Solo admin');return;}
  if(!confirm('¿Borrar todo el changelog?'))return;
  localStorage.removeItem(K_CHANGELOG);loadChangelog();
});

/* LAST UPDATE */
const lastUpdateEl=$("#lastUpdateLabel"), lastUpdateRel=$("#lastUpdateRelative"), manualUpdate=$("#manualUpdate");
function loadLastUpdate(){const t=localStorage.getItem(K_LASTUPDATE);if(t)lastUpdateEl.textContent=new Date(+t).toLocaleString();else{lastUpdateEl.textContent='—';lastUpdateRel.textContent='';}}
function updateLastUpdate(){const now=Date.now();localStorage.setItem(K_LASTUPDATE,String(now));loadLastUpdate();}
manualUpdate?.addEventListener('click',()=>{if(!isAdmin){toast('Solo admin');return;}updateLastUpdate();toast('Timestamp actualizado');});
function relativeFormat(ts){
  const diff=Date.now()-ts,s=Math.floor(diff/1000);if(s<60)return'hace '+s+'s';
  const m=Math.floor(s/60);if(m<60)return'hace '+m+'m';
  const h=Math.floor(m/60);if(h<24)return'hace '+h+'h';
  const d=Math.floor(h/24);return'hace '+d+'d';
}

/* RELATIVE LOOP */
function loopRelative(){const t=localStorage.getItem(K_LASTUPDATE);if(t)lastUpdateRel.textContent=relativeFormat(+t);requestAnimationFrame(loopRelative);}

/* MODES */
const cleanBtn=$("#toggleClean"), streamBtn=$("#toggleStream"), modeBadge=$("#modeBadge"), logoFitBtn=$("#toggleLogoFit"), logoFitChk=$("#logoFitToggleChk");
function applyLogoFit(){
  document.body.classList.toggle('server-cover-mode', !!settings.logoCover);
  logoFitBtn.classList.toggle('is-active', settings.logoCover);
  if(logoFitChk) logoFitChk.checked=settings.logoCover;
}
function applyModes(){
  document.body.classList.toggle('clean-mode', settings.cleanMode);
  document.body.classList.toggle('streaming-mode', settings.streamMode);
  if(settings.streamMode){audioEl.muted=true;playBtn.innerHTML='<i class="fa-solid fa-play"></i> Play';modeBadge.style.display='block';}
  else{modeBadge.style.display='none';if(!audioEl.paused) audioEl.muted=false;}
  applyTilt(settings.tilt);
}
function refreshModeButtons(){
  cleanBtn.classList.toggle('is-active', settings.cleanMode);
  streamBtn.classList.toggle('is-active', settings.streamMode);
}
cleanBtn.addEventListener('click',()=>{
  settings.cleanMode=!settings.cleanMode;saveSettings();applyModes();refreshModeButtons();toast(settings.cleanMode?'Clean Mode ON':'Clean Mode OFF');
});
streamBtn.addEventListener('click',()=>{
  settings.streamMode=!settings.streamMode;saveSettings();applyModes();refreshModeButtons();toast(settings.streamMode?'Stream Mode ON':'Stream Mode OFF');
});
logoFitBtn.addEventListener('click',()=>{
  settings.logoCover=!settings.logoCover;saveSettings();applyLogoFit();toast(settings.logoCover?'Logos COVER':'Logos CONTAIN');
});
logoFitChk?.addEventListener('change',()=>{
  settings.logoCover=logoFitChk.checked;saveSettings();applyLogoFit();
});

/* SETTINGS PANEL */
const settingsPanel=$("#settingsPanel");
$("#openSettings").addEventListener('click',()=>{populateSettingsPanel();settingsPanel.classList.add('open');});
$("#settingsClose").addEventListener('click',()=>settingsPanel.classList.remove('open'));
document.addEventListener('keydown',e=>{
  if(e.key==='Escape'&&settingsPanel.classList.contains('open'))settingsPanel.classList.remove('open');
});
function populateSettingsPanel(){
  $$('input[name="bgmode"]').forEach(r=>r.checked=(r.value===settings.bgMode));
  $("#bgImageUrl").value=settings.bgMode==='image'?settings.bgImageUrl:'';
  $("#bgImageField").style.display=settings.bgMode==='image'?'block':'none';
  $("#tiltToggle").checked=settings.tilt;
  $("#cursorStyle").value=settings.cursor;
  $("#autoplayToggle").checked=settings.musicAutoplay;
  $("#initVol").value=Math.round(settings.musicInitVol*100);
  $("#dynamicBgToggle").checked=settings.dynamicBG;
  $("#cleanToggle").checked=settings.cleanMode;
  $("#streamToggle").checked=settings.streamMode;
  if(logoFitChk) logoFitChk.checked=settings.logoCover;
}
$("#bgModeRow").addEventListener('change',e=>{
  if(e.target.name==='bgmode') $("#bgImageField").style.display=e.target.value==='image'?'block':'none';
});
$("#settingsSave").addEventListener('click',()=>{
  settings.bgMode=$$('input[name="bgmode"]').find(r=>r.checked)?.value||'car';
  settings.bgImageUrl=$("#bgImageUrl").value.trim();
  settings.tilt=$("#tiltToggle").checked;
  settings.cursor=$("#cursorStyle").value;
  settings.musicAutoplay=$("#autoplayToggle").checked;
  settings.musicInitVol=(Number($("#initVol").value)||65)/100;
  settings.dynamicBG=$("#dynamicBgToggle").checked;
  settings.cleanMode=$("#cleanToggle").checked;
  settings.streamMode=$("#streamToggle").checked;
  settings.logoCover=logoFitChk?logoFitChk.checked:settings.logoCover;
  saveSettings();
  audioEl.volume=settings.musicInitVol;
  applyBackground(true);applyCursor(settings.cursor);applyModes();refreshModeButtons();applyLogoFit();
  toast('Configuración guardada');settingsPanel.classList.remove('open');
});

/* COPY / RIPPLE */
document.addEventListener('click',e=>{
  const btn=e.target.closest('.btn,.icon-btn,.mode-btn,.srv-btn');if(btn) ripple(e,btn);
  const cp=e.target.closest('[data-copy]');
  if(cp) navigator.clipboard?.writeText(cp.getAttribute('data-copy')||'').then(()=>toast('Copiado')).catch(()=>toast('Error copiar'));
});

/* DEBUG */
const debugParam=new URLSearchParams(location.search).has('debug');window._debug=debugParam;
if(window._debug) $("#toggleDebug").hidden=false;
$("#toggleDebug").addEventListener('click',()=>$("#debugPanel").classList.toggle('show'));

/* HOTKEYS */
document.addEventListener('keydown',e=>{
  if(e.altKey&&e.shiftKey){
    switch(e.key.toLowerCase()){
      case'a':requestAdmin();break;
      case'x':revokeAdmin();break;
      case'o':requestOwner();break;
      case'p':revokeOwner();break;
      case'e':toggleGlobalEdit();break;
    }
  }
});

/* CLEAN stray dots */
(function cleanDots(){
  const junk=/^([.·•])+$/;const walker=document.createTreeWalker(document.body,NodeFilter.SHOW_TEXT,null);
  const kill=[];while(walker.nextNode()){const n=walker.currentNode;if(junk.test(n.textContent.trim())) kill.push(n);}
  kill.forEach(n=>n.remove());
})();

/* ENTRY */
$("#year").textContent=new Date().getFullYear();
$("#entry").addEventListener('click',()=>{
  $("#entry").classList.add('fade-out');setTimeout(()=>$("#entry").remove(),560);
  applyBackground(true);injectCursor();applyCursor(settings.cursor);applyTilt(settings.tilt);
  audioEl.volume=settings.musicInitVol;
  if(settings.musicAutoplay){
    audioEl.play().then(()=>{playBtn.innerHTML='<i class="fa-solid fa-pause"></i> Pause';updateMusicState();})
      .catch(()=>toast('Autoplay bloqueado'));
  } else updateMusicState();
  initViews();fixEmojiSpacing();
},{once:true});

/* RELATIVE LOOP START */
loopRelative();

/* INIT */
function init(){
  restoreOwnerTexts();restoreOrders();
  if(['aurora','image'].includes(settings.bgMode) || settings.dynamicBG) applyBackground(true);
  loadDoing();loadObjectives();loadChangelog();loadLastUpdate();loadSession();
  applyModes();refreshModeButtons();applyLogoFit();
  audioEl.volume=settings.musicInitVol;updateMusicState();renderSessionTicker();updateViewsUI();fixEmojiSpacing();
}
init();
</script>
</body>
</html>
